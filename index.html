<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Title and Favicon -->
    <title>Arkanat Guard System</title>
    <link rel="icon" type="image/svg+xml" href="https://arkanat.com.sa/wp-content/uploads/2024/07/logo.svg">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #0f172a; /* Dark background */
        }
        .page {
            display: none;
            opacity: 0;
            transition: opacity 0.4s ease-in-out;
            min-height: 100vh;
        }
        .page.active {
            display: flex;
            opacity: 1;
        }
        .table-container {
            max-height: 60vh;
            overflow-y: auto;
            overflow-x: auto; /* Added for horizontal scrolling on small screens */
        }
        .table-container thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #1e293b;
        }
        .custom-tab {
            @apply px-4 py-2 font-medium text-sm rounded-md transition-colors duration-200 cursor-pointer whitespace-nowrap;
        }
        .custom-tab.active-tab {
             @apply bg-blue-600 text-white shadow-lg;
        }
        .custom-tab:not(.active-tab) {
             @apply text-gray-300 hover:bg-slate-700/60 hover:text-white;
        }
        .action-btn {
            @apply text-white px-3 py-1.5 rounded-lg text-xs font-bold transition-all duration-200 shadow-md hover:shadow-lg hover:-translate-y-px flex items-center justify-center gap-1;
        }
        .header-btn {
             @apply text-white font-semibold px-4 py-2 rounded-lg transition;
        }
        .modal-content {
            display: none;
        }
        .modal-content.active {
            display: flex;
        }
        .filter-select {
            @apply bg-slate-700 border border-slate-600 text-white text-sm rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 transition;
        }
        .dashboard-action-btn {
            @apply flex flex-col items-center justify-center gap-2 bg-slate-800 p-6 rounded-xl shadow-lg text-center text-lg font-bold text-gray-200 border border-slate-700 hover:shadow-xl hover:bg-slate-700 hover:-translate-y-1 transition-all duration-300;
        }
        .dashboard-action-btn.check-in { @apply hover:border-green-500; }
        .dashboard-action-btn.check-out { @apply hover:border-red-500; }
        .dashboard-action-btn.request { @apply hover:border-blue-500; }
        .dashboard-action-btn:disabled {
            @apply bg-slate-800/50 text-gray-500 border-slate-800 cursor-not-allowed hover:translate-y-0 hover:shadow-lg;
        }
        .on-duty-status {
            @apply flex items-center gap-2 text-green-400 font-bold animate-pulse;
        }
        .on-leave-status {
            @apply flex items-center gap-2 text-blue-400 font-bold;
        }
        .glowing-text {
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.5), 0 0 10px rgba(255, 255, 255, 0.3);
        }
        .login-option-card { @apply bg-slate-800 p-8 rounded-2xl shadow-lg cursor-pointer transition-all duration-300 hover:shadow-blue-500/20 hover:-translate-y-2 border border-slate-700 hover:border-blue-500; }
        .coverage-card { @apply bg-slate-800/50 p-4 rounded-lg border border-slate-700 flex flex-col sm:flex-row justify-between items-center gap-4; }
    </style>
</head>
<body class="bg-slate-900">

    <!-- =========== New Landing Page =========== -->
    <div id="landing-page" class="page active flex-col justify-center items-center p-4 sm:p-8">
        <div class="w-full max-w-5xl text-center">
            <img src="https://arkanat.com.sa/wp-content/uploads/2024/07/logo.svg" alt="شعار اركانات" class="h-20 sm:h-24 mb-6 mx-auto" onerror="this.onerror=null; this.src='https://placehold.co/200x70/FFFFFF/000000?text=Arkanat';">
            <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold mb-4 text-white">نظام ادارة الحراسات الالكتروني</h1>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6 mt-12">
                 <div class="login-option-card" data-role="guard"><i class="ph-fill ph-user text-blue-400 text-5xl"></i><h3 class="text-xl font-bold mt-4 text-white">دخول الحارس</h3><p class="text-gray-400 text-sm mt-1">تسجيل الحضور وتقديم الطلبات</p></div>
                 <div class="login-option-card" data-role="coverage_guard"><i class="ph-fill ph-users text-teal-400 text-5xl"></i><h3 class="text-xl font-bold mt-4 text-white">حراس التغطيات</h3><p class="text-gray-400 text-sm mt-1">عرض وتقديم على التغطيات</p></div>
                 <div class="login-option-card" data-role="admin"><i class="ph-fill ph-shield-check text-green-400 text-5xl"></i><h3 class="text-xl font-bold mt-4 text-white">دخول المشرف</h3></div>
                 <div class="login-option-card" data-role="operations"><i class="ph-fill ph-chart-line-up text-indigo-400 text-5xl"></i><h3 class="text-xl font-bold mt-4 text-white">إدارة العمليات</h3></div>
                 <div class="login-option-card" data-role="hr"><i class="ph-fill ph-users-three text-orange-400 text-5xl"></i><h3 class="text-xl font-bold mt-4 text-white">الموارد البشرية</h3></div>
            </div>
             <div class="mt-16 text-center">
                 <p class="glowing-text text-gray-300 text-lg">نسخة تجريبية لمعاينة النظام</p>
                 <p class="text-gray-500 text-sm mt-2">تم تصميمه وبرمجته بالكامل من يزيد الصايل.</p>
             </div>
        </div>
    </div>

    <!-- =========== Unified Login Page =========== -->
    <div id="login-page" class="page justify-center items-center bg-slate-900 p-4">
        <div class="w-full max-w-md bg-slate-800 border border-slate-700 rounded-2xl shadow-2xl p-8 space-y-6">
            <div class="text-center"><h2 id="login-title" class="text-3xl font-bold text-white">تسجيل الدخول</h2></div>
            <div><label for="login-id" class="block text-sm font-medium text-gray-300 mb-2">اسم المستخدم</label><input type="text" id="login-id" class="w-full p-3 bg-slate-700 text-white border border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 transition"></div>
            <div><label for="login-password" class="block text-sm font-medium text-gray-300 mb-2">كلمة المرور</label><input type="password" id="login-password" class="w-full p-3 bg-slate-700 text-white border border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 transition"></div>
            <button id="login-btn" class="w-full bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-700 transition">دخول</button>
            <button id="login-back-btn" class="w-full bg-slate-700 text-gray-300 p-3 rounded-lg font-bold hover:bg-slate-600 transition">رجوع</button>
        </div>
    </div>
    
    <!-- =========== Guard Dashboard Page =========== -->
    <div id="guard-dashboard-page" class="page flex-col justify-center items-center bg-slate-900 p-4">
        <div class="w-full max-w-5xl bg-slate-800 border border-slate-700 rounded-2xl shadow-2xl">
             <div class="p-6 border-b border-slate-700 flex justify-between items-center"><h2 class="text-2xl font-bold text-white">مرحباً بك، <span id="guard-name-display"></span></h2><button class="logout-btn header-btn bg-red-600 hover:bg-red-700">تسجيل الخروج</button></div>
            <div id="guard-buttons-container" class="p-6 grid grid-cols-2 md:grid-cols-4 gap-4">
                <button id="check-in-btn" class="dashboard-action-btn check-in"><i class="ph-fill ph-fingerprint text-4xl"></i>تسجيل حضور</button>
                <button id="check-out-btn" class="dashboard-action-btn check-out"><i class="ph-fill ph-sign-out text-4xl"></i>انصراف من الموقع</button>
                <button class="dashboard-action-btn request" data-modal="leave-modal"><i class="ph-fill ph-calendar-plus text-4xl"></i>طلب إجازة</button>
                <button class="dashboard-action-btn request" data-modal="loan-modal"><i class="ph-fill ph-money text-4xl"></i>طلب سلفة</button>
                <button class="dashboard-action-btn request" data-modal="permission-modal"><i class="ph-fill ph-timer text-4xl"></i>طلب استئذان</button>
                <button class="dashboard-action-btn request" data-modal="overtime-modal"><i class="ph-fill ph-clock-clockwise text-4xl"></i>طلب عمل إضافي</button>
                <button class="dashboard-action-btn request" data-modal="resignation-modal"><i class="ph-fill ph-door-open text-4xl"></i>طلب استقالة</button>
            </div>
        </div>
    </div>
    
    <!-- =========== Coverage Guard Dashboard Page =========== -->
    <div id="coverage-guard-dashboard-page" class="page flex-col items-center bg-slate-900 p-4 sm:p-6 md:p-8 w-full">
         <div class="w-full max-w-full lg:max-w-7xl bg-slate-800 border border-slate-700 rounded-2xl shadow-2xl">
              <div class="p-4 sm:p-6 border-b border-slate-700 flex flex-col sm:flex-row justify-between items-center gap-4">
                  <h2 class="text-xl sm:text-2xl font-bold text-white">لوحة تحكم حراس التغطيات: <span id="coverage-guard-name-display"></span></h2>
                  <button class="logout-btn header-btn bg-red-600 hover:bg-red-700">تسجيل الخروج</button>
              </div>
              <div class="border-b border-slate-700 p-2">
                <nav id="coverage-guard-tabs" class="flex space-x-2 overflow-x-auto" aria-label="Tabs">
                    <a href="#" data-tab="available_coverages" class="custom-tab active-tab">التغطيات المتوفرة</a>
                    <a href="#" data-tab="my_coverages" class="custom-tab">تغطياتي</a>
                </nav>
            </div>
              <div id="coverage-guard-tab-content" class="p-4"></div>
        </div>
    </div>

    <!-- =========== Admin/Ops Dashboard Page =========== -->
    <div id="admin-dashboard-page" class="page flex-col items-center bg-slate-900 p-4 sm:p-6 md:p-8 w-full">
         <div class="w-full max-w-full lg:max-w-7xl bg-slate-800 border border-slate-700 rounded-2xl shadow-2xl">
              <div class="p-4 sm:p-6 border-b border-slate-700 flex flex-col sm:flex-row justify-between items-center gap-4">
                  <h2 id="admin-dashboard-title" class="text-xl sm:text-2xl font-bold text-white">لوحة التحكم</h2>
                  <div id="admin-header-actions" class="flex flex-wrap justify-center sm:justify-end items-center gap-3">
                      <!-- Buttons are added dynamically by JS -->
                  </div>
              </div>
              <div class="border-b border-slate-700 p-2"><nav id="admin-ops-tabs" class="flex space-x-2 overflow-x-auto" aria-label="Tabs"></nav></div>
              <div id="admin-tab-content" class="p-4"></div>
        </div>
    </div>
    
    <!-- =========== HR Dashboard Page =========== -->
    <div id="hr-dashboard-page" class="page flex-col items-center bg-slate-900 p-4 sm:p-6 md:p-8 w-full">
        <div class="w-full max-w-full lg:max-w-7xl bg-slate-800 border border-slate-700 rounded-2xl shadow-2xl">
            <div class="p-4 sm:p-6 border-b border-slate-700 flex flex-col sm:flex-row justify-between items-center gap-4">
                <h2 class="text-xl sm:text-2xl font-bold text-white">لوحة تحكم الموارد البشرية</h2>
                 <div id="hr-header-actions" class="flex flex-wrap justify-center sm:justify-end items-center gap-3">
                     <button id="hr-export-csv-btn" data-target-table="" class="header-btn bg-blue-600 hover:bg-blue-700">تصدير CSV</button>
                     <button class="logout-btn header-btn bg-red-600 hover:bg-red-700">تسجيل الخروج</button>
                 </div>
            </div>
            <div class="border-b border-slate-700 p-2"><nav id="hr-tabs" class="flex space-x-2 overflow-x-auto"></nav></div>
            <div id="hr-tab-content" class="p-4"></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal-container" class="hidden fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 p-4 overflow-y-auto">
        <!-- Add/Edit Guard Modal -->
        <div class="modal-content flex-col w-full max-w-3xl bg-slate-800 text-white border border-slate-700 rounded-lg shadow-xl" id="guard-form-modal">
            <h3 id="guard-form-title-text" class="text-xl font-bold p-4 border-b border-slate-700"></h3>
            <div class="p-6 space-y-6 max-h-[80vh] overflow-y-auto">
                <input type="hidden" id="guard-form-id">
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                    <input id="guard-form-name" type="text" placeholder="اسم الحارس الكامل" class="p-2 border bg-slate-700 border-slate-600 rounded-md md:col-span-3">
                    <input id="guard-form-national-id" type="text" placeholder="رقم الهوية" class="p-2 border bg-slate-700 border-slate-600 rounded-md">
                    <input id="guard-form-mobile" type="text" placeholder="رقم الجوال" class="p-2 border bg-slate-700 border-slate-600 rounded-md">
                    <input id="guard-form-password" type="text" placeholder="كلمة المرور (اتركه فارغاً لعدم التغيير)" class="p-2 border bg-slate-700 border-slate-600 rounded-md">
                    <input id="guard-form-job-title" type="text" placeholder="المسمى الوظيفي" class="p-2 border bg-slate-700 border-slate-600 rounded-md">
                    <input id="guard-form-location" type="text" placeholder="الموقع" class="p-2 border bg-slate-700 border-slate-600 rounded-md">
                    <input id="guard-form-region" type="text" placeholder="المنطقة" class="p-2 border bg-slate-700 border-slate-600 rounded-md">
                    <input id="guard-form-project" type="text" placeholder="المشروع" class="p-2 border bg-slate-700 border-slate-600 rounded-md">
                     <div>
                         <label for="guard-form-status" class="block text-sm font-medium text-gray-300 mb-1">حالة الموظف</label>
                         <select id="guard-form-status" class="filter-select">
                             <option value="اساسي">أساسي</option>
                             <option value="بديل">بديل</option>
                         </select>
                     </div>
                    <input id="guard-form-basic-salary" type="number" placeholder="راتب اساسي" class="p-2 border bg-slate-700 border-slate-600 rounded-md">
                    <input id="guard-form-housing-allowance" type="number" placeholder="بدل سكن" class="p-2 border bg-slate-700 border-slate-600 rounded-md">
                    <input id="guard-form-transport-allowance" type="number" placeholder="بدل نقل" class="p-2 border bg-slate-700 border-slate-600 rounded-md">
                    <input id="guard-form-other-allowances" type="number" placeholder="بدلات اخرى" class="p-2 border bg-slate-700 border-slate-600 rounded-md">
                </div>
                <fieldset class="border border-slate-600 p-4 rounded-lg">
                    <legend class="px-2 font-semibold text-gray-300">جدول الدوام الأسبوعي</legend>
                    <div id="guard-form-schedule-container" class="space-y-2"></div>
                </fieldset>
            </div>
            <div class="p-4 bg-slate-900 flex justify-end gap-3"><button class="modal-close-btn font-semibold bg-slate-600 text-white px-4 py-2 rounded-lg transition hover:bg-slate-500">إغلاق</button><button id="submit-guard-form-btn" class="font-semibold bg-blue-600 text-white px-4 py-2 rounded-lg transition hover:bg-blue-700">حفظ</button></div>
        </div>

        <!-- Add/Edit Coverage Guard Modal -->
        <div class="modal-content flex-col w-full max-w-lg bg-slate-800 text-white border border-slate-700 rounded-lg shadow-xl" id="coverage-guard-form-modal">
            <h3 id="coverage-guard-form-title" class="text-xl font-bold p-4 border-b border-slate-700"></h3>
            <input type="hidden" id="coverage-guard-form-id">
            <div class="p-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
                <input id="coverage-guard-form-name" type="text" placeholder="الاسم الكامل" class="p-2 border bg-slate-700 border-slate-600 rounded-md sm:col-span-2">
                <input id="coverage-guard-form-national-id" type="text" placeholder="رقم الهوية" class="p-2 border bg-slate-700 border-slate-600 rounded-md">
                <input id="coverage-guard-form-mobile" type="text" placeholder="رقم الجوال" class="p-2 border bg-slate-700 border-slate-600 rounded-md">
                <input id="coverage-guard-form-password" type="text" placeholder="كلمة المرور" class="p-2 border bg-slate-700 border-slate-600 rounded-md sm:col-span-2">
            </div>
            <div class="p-4 bg-slate-900 flex justify-end gap-3">
                <button class="modal-close-btn font-semibold bg-slate-600 text-white px-4 py-2 rounded-lg transition hover:bg-slate-500">إغلاق</button>
                <button id="submit-coverage-guard-form-btn" class="font-semibold bg-blue-600 text-white px-4 py-2 rounded-lg transition hover:bg-blue-700">حفظ</button>
            </div>
        </div>
        
        <!-- Add/Edit Coverage Site Modal -->
        <div class="modal-content flex-col w-full max-w-lg bg-slate-800 text-white border border-slate-700 rounded-lg shadow-xl" id="coverage-site-form-modal">
            <h3 id="coverage-site-form-title" class="text-xl font-bold p-4 border-b border-slate-700"></h3>
            <input type="hidden" id="coverage-site-form-id">
            <div class="p-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
                <input id="coverage-site-project" type="text" placeholder="المشروع" class="p-2 border bg-slate-700 border-slate-600 rounded-md">
                <input id="coverage-site-location" type="text" placeholder="الموقع" class="p-2 border bg-slate-700 border-slate-600 rounded-md">
                <div class="sm:col-span-2">
                     <label for="coverage-site-date" class="block text-sm font-medium text-gray-300 mb-1">التاريخ</label>
                     <input id="coverage-site-date" type="date" class="p-2 w-full border bg-slate-700 border-slate-600 rounded-md">
                </div>
                 <div class="sm:col-span-2">
                     <label for="coverage-site-day" class="block text-sm font-medium text-gray-300 mb-1">اليوم</label>
                     <select id="coverage-site-day" class="filter-select">
                        <option value="السبت">السبت</option>
                        <option value="الأحد">الأحد</option>
                        <option value="الإثنين">الإثنين</option>
                        <option value="الثلاثاء">الثلاثاء</option>
                        <option value="الأربعاء">الأربعاء</option>
                        <option value="الخميس">الخميس</option>
                        <option value="الجمعة">الجمعة</option>
                     </select>
                </div>
                 <div>
                     <label for="coverage-site-start-time" class="block text-sm font-medium text-gray-300 mb-1">من</label>
                     <input id="coverage-site-start-time" type="time" class="p-2 w-full border bg-slate-700 border-slate-600 rounded-md">
                </div>
                 <div>
                     <label for="coverage-site-end-time" class="block text-sm font-medium text-gray-300 mb-1">إلى</label>
                     <input id="coverage-site-end-time" type="time" class="p-2 w-full border bg-slate-700 border-slate-600 rounded-md">
                </div>
                <div class="sm:col-span-2">
                    <label for="coverage-site-payout" class="block text-sm font-medium text-gray-300 mb-1">المبلغ المستحق</label>
                    <input id="coverage-site-payout" type="number" placeholder="المبلغ" class="p-2 w-full border bg-slate-700 border-slate-600 rounded-md">
                </div>
            </div>
            <div class="p-4 bg-slate-900 flex justify-end gap-3">
                <button class="modal-close-btn font-semibold bg-slate-600 text-white px-4 py-2 rounded-lg transition hover:bg-slate-500">إغلاق</button>
                <button id="submit-coverage-site-form-btn" class="font-semibold bg-blue-600 text-white px-4 py-2 rounded-lg transition hover:bg-blue-700">حفظ</button>
            </div>
        </div>

        <!-- Add/Edit Staff Modal -->
        <div class="modal-content flex-col w-full max-w-lg bg-slate-800 text-white border border-slate-700 rounded-lg shadow-xl" id="staff-form-modal">
            <h3 id="staff-form-title" class="text-xl font-bold p-4 border-b border-slate-700"></h3>
            <input type="hidden" id="staff-form-id">
            <input type="hidden" id="staff-form-role">
            <div class="p-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
                <input id="staff-form-name" type="text" placeholder="الاسم الكامل" class="p-2 border bg-slate-700 border-slate-600 rounded-md sm:col-span-2">
                <input id="staff-form-username" type="text" placeholder="اسم المستخدم" class="p-2 border bg-slate-700 border-slate-600 rounded-md">
                <input id="staff-form-password" type="text" placeholder="كلمة المرور (اتركه فارغاً)" class="p-2 border bg-slate-700 border-slate-600 rounded-md">
                <div id="staff-form-title-container" class="sm:col-span-2">
                    <label for="staff-form-title-input" class="block text-sm font-medium text-gray-300 mb-2">المسمى الوظيفي</label>
                    <input id="staff-form-title-input" type="text" placeholder="المسمى الوظيفي" class="p-2 w-full border bg-slate-700 border-slate-600 rounded-md">
                </div>
                <div id="staff-form-assignment-container" class="sm:col-span-2 space-y-3">
                    <label class="block text-sm font-medium text-gray-300">المشاريع المسندة</label>
                    <div id="staff-form-assignments-list"></div>
                    <button id="add-assignment-btn" class="text-sm text-blue-400 hover:text-blue-300">+ إضافة مشروع آخر</button>
                </div>
            </div>
            <div class="p-4 bg-slate-900 flex justify-end gap-3">
                <button class="modal-close-btn font-semibold bg-slate-600 text-white px-4 py-2 rounded-lg transition hover:bg-slate-500">إغلاق</button>
                <button id="submit-staff-form-btn" class="font-semibold bg-blue-600 text-white px-4 py-2 rounded-lg transition hover:bg-blue-700">حفظ</button>
            </div>
        </div>
        
         <!-- Financial Transaction Modal -->
        <div class="modal-content flex-col w-full max-w-lg bg-slate-800 text-white border border-slate-700 rounded-lg shadow-xl" id="financial-transaction-modal">
            <h3 id="financial-transaction-title" class="text-xl font-bold p-4 border-b border-slate-700"></h3>
            <div class="p-6 space-y-4">
                <input type="hidden" id="financial-transaction-guard-id">
                 <input type="hidden" id="financial-transaction-type">
                <div>
                    <label for="financial-transaction-amount" class="block text-sm font-medium text-gray-300 mb-2">المبلغ</label>
                    <input id="financial-transaction-amount" type="number" placeholder="ادخل المبلغ" class="p-2 w-full border bg-slate-700 border-slate-600 rounded-md">
                </div>
                 <div>
                    <label for="financial-transaction-reason" class="block text-sm font-medium text-gray-300 mb-2">السبب</label>
                    <textarea id="financial-transaction-reason" rows="3" placeholder="ادخل سبب الإجراء" class="p-2 w-full border bg-slate-700 border-slate-600 rounded-md"></textarea>
                </div>
            </div>
            <div class="p-4 bg-slate-900 flex justify-end gap-3">
                <button class="modal-close-btn font-semibold bg-slate-600 text-white px-4 py-2 rounded-lg transition hover:bg-slate-500">إغلاق</button>
                <button id="submit-financial-transaction-btn" class="font-semibold bg-blue-600 text-white px-4 py-2 rounded-lg transition hover:bg-blue-700">تأكيد</button>
            </div>
        </div>

        <!-- Schedule Display Modal -->
        <div class="modal-content flex-col w-full max-w-lg bg-slate-800 text-white border border-slate-700 rounded-lg shadow-xl" id="schedule-display-modal">
            <h3 id="schedule-modal-title" class="text-xl font-bold p-4 border-b border-slate-700">جدول الدوام</h3>
            <div id="schedule-modal-body" class="p-6"></div>
            <div class="p-4 bg-slate-900 flex justify-end gap-3"><button class="modal-close-btn font-semibold bg-slate-600 text-white px-4 py-2 rounded-lg transition hover:bg-slate-500">إغلاق</button></div>
        </div>
        
        <!-- Coverage Application Notes Modal -->
        <div class="modal-content flex-col w-full max-w-lg bg-slate-800 text-white border border-slate-700 rounded-lg shadow-xl" id="coverage-notes-modal">
              <h3 class="text-xl font-bold p-4 border-b border-slate-700">إضافة ملاحظات</h3>
              <div class="p-6 space-y-4">
                  <input type="hidden" id="coverage-notes-coverage-id">
                  <label for="coverage-notes-textarea" class="block text-sm font-medium text-gray-300 mb-2">ملاحظات (اختياري، اتركه فارغاً إذا لم يكن هناك ملاحظات)</label>
                  <textarea id="coverage-notes-textarea" rows="4" class="w-full p-2 border bg-slate-700 border-slate-600 rounded-md"></textarea>
              </div>
              <div class="p-4 bg-slate-900 flex justify-end gap-3">
                  <button class="modal-close-btn font-semibold bg-slate-600 text-white px-4 py-2 rounded-lg transition hover:bg-slate-500">إلغاء</button>
                  <button id="submit-coverage-notes-btn" class="font-semibold bg-blue-600 text-white px-4 py-2 rounded-lg transition hover:bg-blue-700">تأكيد التقديم</button>
              </div>
        </div>

        <!-- Guard Request Modals -->
        <div class="modal-content flex-col w-full max-w-lg bg-slate-800 text-white border border-slate-700 rounded-lg shadow-xl" id="leave-modal">
              <h3 class="text-xl font-bold p-4 border-b border-slate-700">طلب إجازة</h3><div class="p-6 space-y-4"><label for="leave-days" class="block">عدد الأيام المطلوبة</label><input type="number" id="leave-days" class="w-full p-2 border bg-slate-700 border-slate-600 rounded-md" min="1"><label for="leave-reason" class="block">السبب</label><textarea id="leave-reason" rows="3" class="w-full p-2 border bg-slate-700 border-slate-600 rounded-md"></textarea></div>
              <div class="p-4 bg-slate-900 flex justify-end gap-3"><button class="modal-close-btn font-semibold bg-slate-600 text-white px-4 py-2 rounded-lg transition hover:bg-slate-500">إغلاق</button><button id="submit-leave-btn" class="font-semibold bg-blue-600 text-white px-4 py-2 rounded-lg transition hover:bg-blue-700">إرسال الطلب</button></div>
        </div>
        <div class="modal-content flex-col w-full max-w-lg bg-slate-800 text-white border border-slate-700 rounded-lg shadow-xl" id="loan-modal">
              <h3 class="text-xl font-bold p-4 border-b border-slate-700">طلب سلفة</h3><div class="p-6 space-y-4"><label for="loan-amount" class="block">المبلغ المطلوب</label><input type="number" id="loan-amount" class="w-full p-2 border bg-slate-700 border-slate-600 rounded-md" min="1"><label for="loan-reason" class="block">السبب</label><textarea id="loan-reason" rows="3" class="w-full p-2 border bg-slate-700 border-slate-600 rounded-md"></textarea></div>
              <div class="p-4 bg-slate-900 flex justify-end gap-3"><button class="modal-close-btn font-semibold bg-slate-600 text-white px-4 py-2 rounded-lg transition hover:bg-slate-500">إغلاق</button><button id="submit-loan-btn" class="font-semibold bg-blue-600 text-white px-4 py-2 rounded-lg transition hover:bg-blue-700">إرسال الطلب</button></div>
        </div>
        <div class="modal-content flex-col w-full max-w-lg bg-slate-800 text-white border border-slate-700 rounded-lg shadow-xl" id="permission-modal">
              <h3 class="text-xl font-bold p-4 border-b border-slate-700">طلب استئذان</h3><div class="p-6 space-y-4"><label for="permission-reason" class="block">سبب الاستئذان</label><textarea id="permission-reason" rows="3" class="w-full p-2 border bg-slate-700 border-slate-600 rounded-md"></textarea></div>
              <div class="p-4 bg-slate-900 flex justify-end gap-3"><button class="modal-close-btn font-semibold bg-slate-600 text-white px-4 py-2 rounded-lg transition hover:bg-slate-500">إغلاق</button><button id="submit-permission-btn" class="font-semibold bg-blue-600 text-white px-4 py-2 rounded-lg transition hover:bg-blue-700">إرسال الطلب</button></div>
        </div>
        <div class="modal-content flex-col w-full max-w-lg bg-slate-800 text-white border border-slate-700 rounded-lg shadow-xl" id="overtime-modal">
              <h3 class="text-xl font-bold p-4 border-b border-slate-700">طلب عمل إضافي</h3><div class="p-6 space-y-4"><label for="overtime-reason" class="block">تفاصيل العمل الإضافي المطلوب</label><textarea id="overtime-reason" rows="3" class="w-full p-2 border bg-slate-700 border-slate-600 rounded-md"></textarea></div>
              <div class="p-4 bg-slate-900 flex justify-end gap-3"><button class="modal-close-btn font-semibold bg-slate-600 text-white px-4 py-2 rounded-lg transition hover:bg-slate-500">إغلاق</button><button id="submit-overtime-btn" class="font-semibold bg-blue-600 text-white px-4 py-2 rounded-lg transition hover:bg-blue-700">إرسال الطلب</button></div>
        </div>
        <div class="modal-content flex-col w-full max-w-lg bg-slate-800 text-white border border-slate-700 rounded-lg shadow-xl" id="resignation-modal">
              <h3 class="text-xl font-bold p-4 border-b border-slate-700">طلب استقالة</h3><div class="p-6 space-y-4"><label for="resignation-reason" class="block">سبب الاستقالة</label><textarea id="resignation-reason" rows="4" class="w-full p-2 border bg-slate-700 border-slate-600 rounded-md"></textarea></div>
              <div class="p-4 bg-slate-900 flex justify-end gap-3"><button class="modal-close-btn font-semibold bg-slate-600 text-white px-4 py-2 rounded-lg transition hover:bg-slate-500">إغلاق</button><button id="submit-resignation-btn" class="font-semibold bg-red-600 text-white px-4 py-2 rounded-lg transition hover:bg-red-700">تقديم طلب الاستقالة</button></div>
        </div>
        
        <!-- Guard Transfer Modal -->
        <div class="modal-content flex-col w-full max-w-lg bg-slate-800 text-white border border-slate-700 rounded-lg shadow-xl" id="transfer-request-modal">
             <h3 class="text-xl font-bold p-4 border-b border-slate-700">رفع طلب نقل حارس</h3>
             <div class="p-6 space-y-4">
                 <div>
                     <label for="transfer-guard-select" class="block text-sm font-medium text-gray-300 mb-2">اختر الحارس</label>
                     <select id="transfer-guard-select" class="filter-select"></select>
                 </div>
                 <div>
                     <label for="transfer-new-location" class="block text-sm font-medium text-gray-300 mb-2">الموقع الجديد</label>
                     <input type="text" id="transfer-new-location" class="p-2 w-full border bg-slate-700 border-slate-600 rounded-md">
                 </div>
                  <div>
                     <label for="transfer-new-project" class="block text-sm font-medium text-gray-300 mb-2">المشروع الجديد</label>
                     <input type="text" id="transfer-new-project" class="p-2 w-full border bg-slate-700 border-slate-600 rounded-md">
                 </div>
                  <div>
                     <label for="transfer-reason" class="block text-sm font-medium text-gray-300 mb-2">سبب النقل</label>
                     <textarea id="transfer-reason" rows="3" class="w-full p-2 border bg-slate-700 border-slate-600 rounded-md"></textarea>
                 </div>
             </div>
             <div class="p-4 bg-slate-900 flex justify-end gap-3">
                 <button class="modal-close-btn font-semibold bg-slate-600 text-white px-4 py-2 rounded-lg transition hover:bg-slate-500">إغلاق</button>
                 <button id="submit-transfer-request-btn" class="font-semibold bg-blue-600 text-white px-4 py-2 rounded-lg transition hover:bg-blue-700">إرسال الطلب</button>
             </div>
        </div>

        <!-- Rejection Reason Modal -->
        <div class="modal-content flex-col w-full max-w-lg bg-slate-800 text-white border border-slate-700 rounded-lg shadow-xl" id="rejection-reason-modal">
             <h3 class="text-xl font-bold p-4 border-b border-slate-700">سبب الرفض</h3>
             <div class="p-6 space-y-4">
                 <input type="hidden" id="rejection-item-id">
                 <input type="hidden" id="rejection-table-name">
                  <div>
                     <label for="rejection-reason-input" class="block text-sm font-medium text-gray-300 mb-2">يرجى ذكر سبب رفض الطلب</label>
                     <textarea id="rejection-reason-input" rows="4" class="w-full p-2 border bg-slate-700 border-slate-600 rounded-md"></textarea>
                 </div>
             </div>
             <div class="p-4 bg-slate-900 flex justify-end gap-3">
                 <button class="modal-close-btn font-semibold bg-slate-600 text-white px-4 py-2 rounded-lg transition hover:bg-slate-500">إلغاء</button>
                 <button id="submit-rejection-btn" class="font-semibold bg-red-600 text-white px-4 py-2 rounded-lg transition hover:bg-red-700">تأكيد الرفض</button>
             </div>
        </div>
        
        <!-- *** NEW: Added Missing Attendance Modal *** -->
        <div class="modal-content flex-col w-full max-w-lg bg-slate-800 text-white border border-slate-700 rounded-lg shadow-xl" id="attendance-modal">
            <h3 class="text-xl font-bold p-4 border-b border-slate-700">تسجيل حضور</h3>
            <div class="p-6 space-y-4">
                <label for="guard-notes" class="block">ملاحظات (اختياري)</label>
                <textarea id="guard-notes" rows="3" class="w-full p-2 border bg-slate-700 border-slate-600 rounded-md"></textarea>
            </div>
            <div class="p-4 bg-slate-900 flex justify-end gap-3">
                <button class="modal-close-btn font-semibold bg-slate-600 text-white px-4 py-2 rounded-lg transition hover:bg-slate-500">إغلاق</button>
                <button id="submit-attendance-btn" class="font-semibold bg-blue-600 text-white px-4 py-2 rounded-lg transition hover:bg-blue-700">تأكيد الحضور</button>
            </div>
        </div>

        <!-- Universal Modals -->
        <div class="modal-content flex-col w-full max-w-sm bg-slate-800 text-white border border-slate-700 rounded-lg shadow-xl" id="confirm-modal">
            <h3 id="confirm-title" class="text-xl font-bold p-4">تأكيد الإجراء</h3><p id="confirm-message" class="p-6 text-lg"></p><div class="p-4 bg-slate-900 flex justify-end gap-3"><button id="confirm-cancel-btn" class="font-semibold bg-slate-600 text-white px-4 py-2 rounded-lg transition hover:bg-slate-500">لا</button><button id="confirm-ok-btn" class="font-semibold bg-red-600 text-white px-4 py-2 rounded-lg transition hover:bg-red-700">نعم</button></div>
        </div>
    </div>
    
    <div id="alert-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 p-4"><div class="bg-slate-800 border border-slate-600 rounded-lg shadow-xl p-6 text-center w-full max-w-sm"><p id="alert-message" class="text-lg mb-6 text-white"></p><button id="alert-close-btn" class="bg-blue-600 text-white px-8 py-2 rounded-lg hover:bg-blue-700">موافق</button></div></div>
    <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50"><div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white"></div></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const runApp = async () => {
            const SUPABASE_URL = 'https://tlgyxbdjdhdjgkcndxoi.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRsZ3l4YmRqZGhkamdrY25keG9pIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAwOTU4NzMsImV4cCI6MjA2NTY3MTg3M30.fX6ek2_xIdSzu_71cmsXWweZXP6cSeFlv8NTlVFKzZg';
            const { createClient } = supabase;
            const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            let state = { currentGuard: null, currentUser: null, currentRole: null, allGuardsData: [], allStaffData: [], allCoverageGuardsData: [], activeAttendanceId: null, allLeaveRequests: [] };
            const dom = {
                pages: document.querySelectorAll('.page'), 
                loading: document.getElementById('loading-overlay'), 
                alertModal: document.getElementById('alert-modal'), 
                alertMessage: document.getElementById('alert-message'), 
                modalContainer: document.getElementById('modal-container'), 
                modalContents: document.querySelectorAll('.modal-content'), 
                loginTitle: document.getElementById('login-title'), 
                guardNameDisplay: document.getElementById('guard-name-display'), 
                coverageGuardNameDisplay: document.getElementById('coverage-guard-name-display'),
                adminDashboardTitle: document.getElementById('admin-dashboard-title'), 
                adminTabContent: document.getElementById('admin-tab-content'), 
                hrTabs: document.getElementById('hr-tabs'), 
                hrTabContent: document.getElementById('hr-tab-content'), 
                checkInBtn: document.getElementById('check-in-btn'), 
                checkOutBtn: document.getElementById('check-out-btn'),
                coverageGuardTabs: document.getElementById('coverage-guard-tabs'),
                coverageGuardTabContent: document.getElementById('coverage-guard-tab-content'),
                scheduleModal: { title: document.getElementById('schedule-modal-title'), body: document.getElementById('schedule-modal-body') },
                confirmModal: { title: document.getElementById('confirm-title'), message: document.getElementById('confirm-message'), okBtn: document.getElementById('confirm-ok-btn'), cancelBtn: document.getElementById('confirm-cancel-btn') }
            };

            const showPage = (pageId) => { dom.pages.forEach(p => p.classList.remove('active')); document.getElementById(pageId)?.classList.add('active'); };
            const showLoading = (isLoading) => dom.loading.style.display = isLoading ? 'flex' : 'none';
            const showAlert = (message) => { dom.alertMessage.textContent = message; dom.alertModal.style.display = 'flex'; };
            const showModal = (modalId) => { dom.modalContainer.style.display = 'flex'; dom.modalContents.forEach(m => m.classList.remove('active')); document.getElementById(modalId)?.classList.add('active'); };
            const closeModal = () => { dom.modalContainer.style.display = 'none'; dom.alertModal.style.display = 'none'; };
            const confirmAction = (title, message) => { return new Promise((resolve) => { dom.confirmModal.title.textContent = title; dom.confirmModal.message.textContent = message; showModal('confirm-modal'); dom.confirmModal.okBtn.onclick = () => { closeModal(); resolve(true); }; dom.confirmModal.cancelBtn.onclick = () => { closeModal(); resolve(false); }; }); };
            const logActivity = async (actor, action, details = '') => { await _supabase.from('activity_log').insert({ actor, action, details }); };
            const formatDuration = (ms) => { if (ms < 0) ms = 0; const s = Math.floor(ms / 1000); const h = Math.floor(s / 3600); const m = Math.floor((s % 3600) / 60); return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${(s % 60).toString().padStart(2, '0')}`; };
            
            const getGeolocation = () => {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        reject(new Error('Geolocation is not supported by your browser.'));
                        return;
                    }
                    navigator.geolocation.getCurrentPosition(
                        (position) => resolve(position.coords),
                        (error) => reject(error)
                    );
                });
            };

            const calculateEntitlement = (guard, workDurationMs) => {
                if (!guard) return 0;
                const totalSalary = (guard.basic_salary || 0) + (guard.housing_allowance || 0) + (guard.transport_allowance || 0) + (guard.other_allowances || 0);
                if (totalSalary === 0) return 0;
                const dailyRate = totalSalary / 30;
                const hourlyRate = dailyRate / 8; // Standard 8-hour day
                const workHours = workDurationMs / (1000 * 60 * 60);
                const entitlement = workHours * hourlyRate;
                return parseFloat(entitlement.toFixed(2));
            };

            const fetchAllGuards = async () => {
                const { data, error } = await _supabase.from('guards').select('*');
                if (error) { console.error("Failed to fetch guards data:", error); showAlert("فشل تحميل بيانات الحراس."); return []; }
                state.allGuardsData = data;
                return data;
            };

            const fetchAllStaff = async () => {
                const { data, error } = await _supabase.from('staff').select('*');
                if (error) { console.error("Failed to fetch staff data:", error); showAlert("فشل تحميل بيانات الموظفين."); return []; }
                state.allStaffData = data;
                return data;
            };

            const fetchAllCoverageGuards = async () => {
                const { data, error } = await _supabase.from('coverage_guards').select('*');
                if (error) { console.error("Failed to fetch coverage guards data:", error); showAlert("فشل تحميل بيانات حراس التغطية."); return []; }
                state.allCoverageGuardsData = data;
                return data;
            };

             const fetchAllLeaveRequests = async () => {
                const { data, error } = await _supabase.from('leave_requests').select('*').eq('status', 'Approved');
                if (error) { console.error("Failed to fetch leave requests:", error); return; }
                state.allLeaveRequests = data;
            };

            const getGuardStatus = (guardId) => {
                const today = new Date();
                today.setHours(0,0,0,0);
                const activeLeave = state.allLeaveRequests.find(leave => {
                    const startDate = new Date(leave.created_at);
                    startDate.setHours(0,0,0,0);
                    const endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + leave.days_requested);
                    return leave.guard_id === guardId && today >= startDate && today < endDate;
                });
                
                if (activeLeave) {
                    const endDate = new Date(new Date(activeLeave.created_at).setDate(new Date(activeLeave.created_at).getDate() + activeLeave.days_requested));
                    const remainingDays = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
                    return { onLeave: true, totalDays: activeLeave.days_requested, remainingDays: remainingDays > 0 ? remainingDays : 0 };
                }
                return { onLeave: false };
            }

            const updateGuardButtonState = async (guardId) => {
                const todayStart = new Date(); todayStart.setHours(0, 0, 0, 0); const todayEnd = new Date(); todayEnd.setHours(23, 59, 59, 999);
                const { data, error } = await _supabase.from('attendance').select('id, checkout_at').eq('guard_id', guardId).gte('created_at', todayStart.toISOString()).lte('created_at', todayEnd.toISOString()).is('checkout_at', null).order('created_at', { ascending: false }).limit(1);
                if (error || !data || data.length === 0) { dom.checkInBtn.disabled = false; dom.checkOutBtn.disabled = true; state.activeAttendanceId = null; }
                else { dom.checkInBtn.disabled = true; dom.checkOutBtn.disabled = false; state.activeAttendanceId = data[0].id; }
            };
            
            const renderTable = (container, columns, data) => {
                if (!container) return;
                let tableHTML = `<div class="table-container"><table class="w-full text-right text-sm text-gray-300">
                                        <thead class="bg-slate-700 text-xs uppercase"><tr>`;
                columns.forEach(col => tableHTML += `<th class="p-3 font-bold text-gray-300 whitespace-nowrap">${col.header}</th>`);
                tableHTML += `</tr></thead><tbody class="divide-y divide-slate-700">`;
                if (!data || data.length === 0) { tableHTML += `<tr><td colspan="${columns.length}" class="text-center p-8 text-gray-400">لا توجد بيانات لعرضها.</td></tr>`; }
                else { data.forEach(row => { let rowClass = row.status === 'Approved' ? 'bg-green-500/10' : (row.status === 'Rejected' || row.status === 'Cancelled by HR' ? 'bg-red-500/10' : ''); tableHTML += `<tr id="row-${row.id}" class="${rowClass} hover:bg-slate-700/50 transition-colors duration-300">`; columns.forEach(col => { tableHTML += `<td class="p-3 break-words align-middle">${col.render(row)}</td>`; }); tableHTML += `</tr>`; }); }
                tableHTML += `</tbody></table></div>`; container.innerHTML = tableHTML;
            };

              // --- NEW: Coverage Guard Dashboard ---
            const loadCoverageGuardDashboard = async (initialTab = 'available_coverages') => {
                showPage('coverage-guard-dashboard-page');
                dom.coverageGuardNameDisplay.textContent = state.currentGuard.name;

                const loadTabData = async (tab) => {
                    showLoading(true);
                    if (dom.coverageGuardTabs) {
                        dom.coverageGuardTabs.querySelectorAll('.custom-tab').forEach(t => t.classList.remove('active-tab'));
                        dom.coverageGuardTabs.querySelector(`.custom-tab[data-tab="${tab}"]`)?.classList.add('active-tab');
                    }
                    const contentContainer = dom.coverageGuardTabContent;
                    if (!contentContainer) { showLoading(false); return; }
                    contentContainer.innerHTML = '';
                    let error;

                    if (tab === 'available_coverages') {
                        const { data: coverages, error: covError } = await _supabase.from('coverages').select('*').eq('status', 'Available').order('coverage_date');
                        const { data: applications, error: appError } = await _supabase.from('coverage_applications').select('coverage_id').eq('guard_id', state.currentGuard.id);
                        error = covError || appError;
                        
                        if (error) {
                            showAlert('فشل تحميل التغطيات المتاحة.');
                        } else if (!coverages || coverages.length === 0) {
                            contentContainer.innerHTML = '<p class="text-center p-8 text-gray-400">لا توجد تغطيات متاحة حالياً.</p>';
                        } else {
                            const appliedCoverageIds = new Set(applications.map(app => app.coverage_id));
                            const cardsHTML = coverages.map(c => {
                                const hasApplied = appliedCoverageIds.has(c.id);
                                const shiftInfo = c.shift_details || `${c.shift_day} (${c.shift_start} - ${c.shift_end})`;
                                return `
                                <div class="coverage-card">
                                    <div class="flex-grow">
                                        <h3 class="text-lg font-bold text-white">${c.project} - ${c.location}</h3>
                                        <div class="flex flex-wrap gap-x-4 gap-y-1 text-sm text-gray-300 mt-2">
                                            <span><i class="ph-fill ph-calendar-blank"></i> ${new Date(c.coverage_date).toLocaleDateString('ar-SA')}</span>
                                            <span><i class="ph-fill ph-clock"></i> ${shiftInfo}</span>
                                            <span class="font-bold text-green-400"><i class="ph-fill ph-money"></i> ${c.payout_amount} ريال</span>
                                        </div>
                                    </div>
                                    <button 
                                        class="action-btn mt-3 sm:mt-0 ${hasApplied ? 'bg-gray-500 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'} apply-for-coverage-btn" 
                                        data-coverage-id="${c.id}" 
                                        ${hasApplied ? 'disabled' : ''}>
                                        <i class="ph ph-paper-plane-tilt"></i> ${hasApplied ? 'تم التقديم' : 'تقديم'}
                                    </button>
                                </div>`;
                            }).join('');
                            contentContainer.innerHTML = `<div class="space-y-4">${cardsHTML}</div>`;
                        }
                    } else if (tab === 'my_coverages') {
                        const { data, error: myCovError } = await _supabase
                            .from('coverages')
                            .select('*')
                            .eq('assigned_guard_id', state.currentGuard.id)
                            .order('coverage_date');
                        error = myCovError;

                        if (error) {
                             showAlert('فشل تحميل تغطياتك.');
                        } else if (!data || data.length === 0) {
                            contentContainer.innerHTML = '<p class="text-center p-8 text-gray-400">لم يتم قبولك في أي تغطية بعد.</p>';
                        } else {
                            const cardsHTML = data.map(c => {
                                const shiftInfo = c.shift_details || `${c.shift_day} (${c.shift_start} - ${c.shift_end})`;
                                return `
                                <div class="coverage-card bg-slate-700/50">
                                    <div>
                                        <h3 class="text-lg font-bold text-white">${c.project} - ${c.location}</h3>
                                        <div class="flex flex-wrap gap-x-4 gap-y-1 text-sm text-gray-300 mt-2">
                                            <span><i class="ph-fill ph-calendar-check"></i> ${new Date(c.coverage_date).toLocaleDateString('ar-SA')}</span>
                                            <span><i class="ph-fill ph-clock"></i> ${shiftInfo}</span>
                                            <span class="font-bold text-green-400"><i class="ph-fill ph-money"></i> ${c.payout_amount} ريال</span>
                                        </div>
                                    </div>
                                    <span class="font-bold text-green-400">مقبول</span>
                                </div>`;
                            }).join('');
                             contentContainer.innerHTML = `<div class="space-y-4">${cardsHTML}</div>`;
                        }
                    }
                    showLoading(false);
                };
                
                if (dom.coverageGuardTabs) {
                    dom.coverageGuardTabs.addEventListener('click', (e) => {
                        e.preventDefault();
                        const tabLink = e.target.closest('.custom-tab');
                        if (tabLink) {
                            loadTabData(tabLink.dataset.tab);
                        }
                    });
                }
                loadTabData(initialTab);
            };
            
            const loadAdminDashboard = async (initialTab = 'attendance') => {
                showPage('admin-dashboard-page');
                const role = state.currentRole;
                dom.adminDashboardTitle.textContent = {admin: 'لوحة تحكم المشرف', operations: 'لوحة تحكم العمليات'}[role];
                
                const adminHeaderActions = document.getElementById('admin-header-actions');
                adminHeaderActions.innerHTML = ''; 
                if (role === 'admin') {
                     adminHeaderActions.insertAdjacentHTML('afterbegin', `<button id="transfer-request-btn" class="header-btn bg-purple-600 hover:bg-purple-700">رفع نقل حارس</button>`);
                }
                 adminHeaderActions.insertAdjacentHTML('beforeend', `<button id="admin-export-csv-btn" class="header-btn bg-blue-600 hover:bg-blue-700">تصدير CSV</button>
                                                                         <button class="logout-btn header-btn bg-red-600 hover:bg-red-700">تسجيل الخروج</button>`);

                const tabsContainer = document.getElementById('admin-ops-tabs');
                tabsContainer.innerHTML = '';
                const availableTabs = {
                    attendance: { label: 'الحضور اليومي', roles: ['admin', 'operations'] },
                    permissions: { label: 'طلبات الإستئذان', roles: ['admin', 'operations'] },
                    overtime: { label: 'طلبات العمل الإضافي', roles: ['admin', 'operations'] },
                    transfers: { label: 'طلبات النقل', roles: ['operations'] }
                };
                Object.entries(availableTabs).forEach(([key, tabInfo]) => {
                    if (tabInfo.roles.includes(role)) {
                        tabsContainer.innerHTML += `<a href="#" data-tab="${key}" class="custom-tab">${tabInfo.label}</a>`;
                    }
                });
                
                const loadTabData = async (tab) => {
                    showLoading(true);
                    document.querySelectorAll('#admin-ops-tabs .custom-tab').forEach(t => t.classList.remove('active-tab'));
                    document.querySelector(`#admin-ops-tabs .custom-tab[data-tab="${tab}"]`)?.classList.add('active-tab');
                    const contentContainer = dom.adminTabContent;
                    contentContainer.innerHTML = '';
                    let columns, data, error;
                    await fetchAllGuards();
                    await fetchAllStaff();
                    
                    const tableId = `admin-table-${tab}`;
                    contentContainer.innerHTML = `<div id="${tableId}"></div>`;
                    const tableContainer = contentContainer.querySelector(`#${tableId}`);
                    document.getElementById('admin-export-csv-btn').dataset.targetTable = `#${tableId} table`;


                    switch(tab) {
                        case 'attendance':
                            ({ data, error } = await _supabase.from('attendance').select('*').order('created_at', { ascending: false }));
                            const fullData = data.map(att => ({ ...att, guard: state.allGuardsData.find(g => g.id === att.guard_id) }));
                            columns = [
                                { header: 'اسم الحارس', render: r => r.guard_name },
                                { header: 'وقت الحضور', render: r => new Date(r.created_at).toLocaleString('ar-SA') },
                                { header: 'لوكيشن الحضور', render: r => r.checkin_lat ? `<button class="action-btn bg-blue-500 view-map-btn" data-lat="${r.checkin_lat}" data-lon="${r.checkin_lon}"><i class="ph ph-map-pin"></i> عرض الخريطة</button>` : 'لم يسجل' },
                                { header: 'الحالة', render: r => {
                                    if (!r.checkout_at) {
                                        return `<div class="flex items-center gap-2"><span class="on-duty-status">في موقع العمل</span> 
                                                  <button class="action-btn bg-yellow-600 hover:bg-yellow-700 supervisor-checkout-btn" data-attendance-id="${r.id}" data-guard-id="${r.guard_id}">
                                                      <i class="ph ph-sign-out"></i> خروج
                                                  </button>
                                                </div>`;
                                    }
                                    return `<span>تم الانصراف (${r.work_duration})</span>`;
                                }},
                                { header: 'لوكيشن الانصراف', render: r => r.checkout_lat ? `<button class="action-btn bg-blue-500 view-map-btn" data-lat="${r.checkout_lat}" data-lon="${r.checkout_lon}"><i class="ph ph-map-pin"></i> عرض الخريطة</button>` : 'لم يسجل' },
                                { header: 'الإجراء', render: r => {
                                      const statusMap = { Approved: 'معتمد', Cancelled: 'ملغي' };
                                      if(statusMap[r.status]) {
                                          let button = '';
                                          if (role === 'operations') {
                                              button = `<button class="action-btn bg-orange-600 hover:bg-orange-700 modify-attendance-btn" data-id="${r.id}"><i class="ph ph-pencil-simple"></i> تعديل</button>`
                                          }
                                          return `<div class="flex items-center gap-2"><span class="font-bold ${r.status === 'Approved' ? 'text-green-400' : 'text-red-400'}">${statusMap[r.status]}</span> ${button}</div>
                                                  <span class="text-xs text-gray-400 block">بواسطة: ${r.action_by || '-'}</span>`;
                                      }
                                      return `<div class="flex gap-2">
                                                  <button class="action-btn bg-green-600 hover:bg-green-700 approve-attendance-btn" data-id="${r.id}"><i class="ph ph-check-circle"></i> اعتماد</button>
                                                  <button class="action-btn bg-red-600 hover:bg-red-700 cancel-attendance-btn" data-id="${r.id}"><i class="ph ph-x-circle"></i> إلغاء</button>
                                                </div>`;
                                }}
                            ];
                            renderTable(tableContainer, columns, fullData);
                            break;
                        
                        case 'permissions':
                        case 'overtime':
                            const requestType = tab === 'permissions' ? 'permission_requests' : 'overtime_requests';
                            ({ data, error } = await _supabase.from(requestType).select('*').order('created_at', { ascending: false }));
                             columns = [
                                { header: 'اسم الحارس', render: r => r.guard_name },
                                { header: 'السبب', render: r => r.reason },
                                { header: 'تاريخ الطلب', render: r => new Date(r.created_at).toLocaleString('ar-SA') },
                                { header: 'الحالة', render: r => {
                                    if(r.status !== 'Pending') {
                                        return `<span class="font-bold ${r.status === 'Approved' ? 'text-green-400' : 'text-red-400'}">${r.status === 'Approved' ? 'معتمد' : 'مرفوض'}</span>
                                                <span class="text-xs text-gray-400 block">بواسطة: ${r.processed_by || '-'}</span>`;
                                    }
                                    if(['admin', 'operations'].includes(role)) {
                                       return `<div class="flex gap-2">
                                                   <button class="action-btn bg-green-600 hover:bg-green-700 approve-request-btn" data-id="${r.id}" data-type="${requestType}"><i class="ph ph-check"></i> موافقة</button>
                                                   <button class="action-btn bg-red-600 hover:bg-red-700 reject-request-btn" data-id="${r.id}" data-type="${requestType}"><i class="ph ph-x"></i> رفض</button>
                                               </div>`;
                                    }
                                    return '<span class="text-yellow-400">معلق</span>';
                                }}
                            ];
                            renderTable(tableContainer, columns, data);
                            break;
                        
                        case 'transfers': // Operations only
                             ({ data, error } = await _supabase.from('transfer_requests').select('*').order('created_at', { ascending: false }));
                             columns = [
                                { header: 'اسم الحارس', render: r => r.guard_name },
                                { header: 'من مشروع', render: r => r.current_project },
                                { header: 'إلى موقع', render: r => r.new_location },
                                { header: 'إلى مشروع', render: r => r.new_project },
                                { header: 'السبب', render: r => r.reason },
                                { header: 'مقدم الطلب', render: r => r.from_supervisor_name },
                                { header: 'الحالة', render: r => {
                                    if(r.status !== 'Pending') {
                                        return `<span class="font-bold ${r.status === 'Approved' ? 'text-green-400' : 'text-red-400'}">${r.status === 'Approved' ? 'معتمد' : 'مرفوض'}</span>
                                                <span class="text-xs text-gray-400 block">بواسطة: ${r.processed_by || '-'}</span>
                                                ${r.rejection_reason ? `<span class="text-xs text-red-300 block">سبب الرفض: ${r.rejection_reason}</span>` : ''}
                                                `;
                                    }
                                    return `<div class="flex gap-2">
                                                <button class="action-btn bg-green-600 hover:bg-green-700 approve-transfer-btn" data-id="${r.id}" data-guard-id="${r.guard_id}" data-location="${r.new_location}" data-project="${r.new_project}"><i class="ph ph-check"></i> موافقة</button>
                                                <button class="action-btn bg-red-600 hover:bg-red-700 reject-request-btn" data-id="${r.id}" data-type="transfer_requests"><i class="ph ph-x"></i> رفض</button>
                                            </div>`;
                                }}
                             ];
                             renderTable(tableContainer, columns, data);
                             break;

                    }
                    if(error) showAlert('فشل تحميل البيانات.');
                    showLoading(false);
                };
                
                tabsContainer.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tabLink = e.target.closest('.custom-tab');
                    if (tabLink) {
                        loadTabData(tabLink.dataset.tab);
                    }
                });

                // Load initial tab
                loadTabData(initialTab);
            };

            const loadHrDashboard = async (tab = 'guards') => {
                showPage('hr-dashboard-page'); showLoading(true);
                dom.hrTabs.querySelectorAll('.custom-tab').forEach(t => t.classList.remove('active-tab'));
                dom.hrTabs.querySelector(`.custom-tab[data-tab="${tab}"]`)?.classList.add('active-tab');
                let columns, data, error, container = dom.hrTabContent; container.innerHTML = '';
                await fetchAllGuards();
                await fetchAllLeaveRequests();
                await fetchAllStaff();
                await fetchAllCoverageGuards();

                const tableId = `hr-table-${tab}`;
                const hasAddButton = ['guards', 'hr_staff', 'supervisors', 'operations', 'coverage_recruitment', 'coverage_sites'].includes(tab);
                let addButtonHTML = '';
                if(hasAddButton) {
                    const btnInfo = {
                        guards: { id: 'add-guard-btn', text: 'إضافة حارس جديد' },
                        hr_staff: { id: 'add-staff-btn', text: 'إضافة موظف موارد بشرية', role: 'hr' },
                        supervisors: { id: 'add-staff-btn', text: 'إضافة مشرف', role: 'admin' },
                        operations: { id: 'add-staff-btn', text: 'إضافة موظف عمليات', role: 'operations' },
                        coverage_recruitment: { id: 'add-coverage-guard-btn', text: 'إضافة حارس تغطية' },
                        coverage_sites: { id: 'add-coverage-site-btn', text: 'إنشاء تغطية جديدة' },
                    };
                    addButtonHTML = `<div class="mb-4"><button id="${btnInfo[tab].id}" data-role="${btnInfo[tab].role || ''}" class="header-btn bg-blue-600 hover:bg-blue-700">${btnInfo[tab].text}</button></div>`;
                }
                 container.innerHTML = `${addButtonHTML}<div id="${tableId}"></div>`;
                 const tableContainer = container.querySelector(`#${tableId}`);
                 document.getElementById('hr-export-csv-btn').dataset.targetTable = `#${tableId} table`;
                
                switch(tab) {
                    case 'guards':
                        data = state.allGuardsData;
                        const filtersHTML = `<div id="guards-filters" class="p-4 grid grid-cols-1 md:grid-cols-5 gap-4 items-end bg-slate-800/50 rounded-lg mb-4">
                            <div><label for="search-name" class="block mb-2 text-sm font-medium text-gray-300">بحث بالاسم</label><input type="text" id="search-name" class="bg-slate-700 border border-slate-600 text-white text-sm rounded-lg w-full p-2.5" placeholder="اكتب اسم الحارس..."></div>
                            <div><label for="filter-region" class="block mb-2 text-sm font-medium text-gray-300">المنطقة</label><select id="filter-region" class="filter-select"><option value="">الكل</option>${[...new Set(data.map(i => i.region).filter(Boolean))].map(v => `<option value="${v}">${v}</option>`).join('')}</select></div>
                            <div><label for="filter-location" class="block mb-2 text-sm font-medium text-gray-300">الموقع</label><select id="filter-location" class="filter-select"><option value="">الكل</option>${[...new Set(data.map(i => i.location).filter(Boolean))].map(v => `<option value="${v}">${v}</option>`).join('')}</select></div>
                            <div><label for="filter-project" class="block mb-2 text-sm font-medium text-gray-300">المشروع</label><select id="filter-project" class="filter-select"><option value="">الكل</option>${[...new Set(data.map(i => i.project).filter(Boolean))].map(v => `<option value="${v}">${v}</option>`).join('')}</select></div>
                            <button id="reset-filters-btn" class="w-full font-semibold bg-slate-600 text-white px-4 py-2.5 rounded-lg transition hover:bg-slate-500">إعادة تعيين</button>
                        </div>`;
                        tableContainer.insertAdjacentHTML('beforebegin', filtersHTML);

                        const renderFilteredGuards = () => {
                            const nameFilter = container.querySelector('#search-name').value.toLowerCase();
                            const regionFilter = container.querySelector('#filter-region').value; 
                            const locationFilter = container.querySelector('#filter-location').value; 
                            const projectFilter = container.querySelector('#filter-project').value;
                            const filteredData = state.allGuardsData.filter(g => (!nameFilter || g.name.toLowerCase().includes(nameFilter)) && (!regionFilter || g.region === regionFilter) && (!locationFilter || g.location === locationFilter) && (!projectFilter || g.project === projectFilter));
                            columns = [ 
                                { header: 'الاسم', render: r => r.name }, 
                                { header: 'رقم الهوية', render: r => r.id }, 
                                { header: 'نوع الموظف', render: r => `<span class="font-bold ${r.status === 'اساسي' ? 'text-cyan-400' : 'text-amber-400'}">${r.status || '-'}</span>`},
                                { header: 'الحالة', render: r => {
                                    const status = getGuardStatus(r.id);
                                    if (status.onLeave) {
                                        return `<div class="on-leave-status" title="إجمالي الإجازة: ${status.totalDays} أيام"><i class="ph ph-airplane-takeoff"></i> إجازة (${status.remainingDays} يوم متبقي)</div>`;
                                    }
                                    return `<span class="text-gray-400">متاح</span>`;
                                }},
                                { header: 'الإجراءات', render: r => `<div class="flex gap-2">
                                      <button class="action-btn bg-yellow-500 hover:bg-yellow-600 edit-guard-btn" data-guard-id="${r.id}"><i class="ph ph-pencil-simple"></i> تعديل</button>
                                      <button class="action-btn bg-indigo-500 hover:bg-indigo-600 view-schedule-btn" data-guard-id="${r.id}"><i class="ph ph-calendar"></i> الجدول</button>
                                      <button class="action-btn bg-red-600 hover:bg-red-700 delete-guard-btn" data-guard-id="${r.id}" data-guard-name="${r.name}"><i class="ph ph-trash"></i> حذف</button>
                                      </div>` 
                                }
                            ];
                            renderTable(tableContainer, columns, filteredData);
                        };
                        renderFilteredGuards();
                        container.querySelector('#guards-filters').addEventListener('input', renderFilteredGuards);
                        container.querySelector('#reset-filters-btn').addEventListener('click', () => {
                            container.querySelector('#search-name').value = ''; container.querySelector('#filter-region').value = ''; container.querySelector('#filter-location').value = ''; container.querySelector('#filter-project').value = '';
                            renderFilteredGuards();
                        });
                        break;
                    case 'coverage_recruitment':
                        data = state.allCoverageGuardsData;
                        columns = [
                            { header: 'الاسم', render: r => r.name },
                            { header: 'رقم الهوية', render: r => r.id },
                            { header: 'رقم الجوال', render: r => r.mobile_number || '-' },
                            { header: 'الإجراءات', render: r => `<div class="flex gap-2">
                                  <button class="action-btn bg-yellow-500 hover:bg-yellow-600 edit-coverage-guard-btn" data-guard-id="${r.id}"><i class="ph ph-pencil-simple"></i> تعديل</button>
                                  <button class="action-btn bg-red-600 hover:bg-red-700 delete-coverage-guard-btn" data-guard-id="${r.id}" data-guard-name="${r.name}"><i class="ph ph-trash"></i> حذف</button>
                                  </div>` }
                        ];
                        renderTable(tableContainer, columns, data);
                        break;
                    case 'coverage_sites':
                        const { data: covSites, error: covSitesErr } = await _supabase.from('coverages').select('*').order('coverage_date', { ascending: false });
                        if(covSitesErr) showAlert('فشل تحميل التغطيات.');
                        else {
                            columns = [
                                { header: 'المشروع', render: r => r.project },
                                { header: 'الموقع', render: r => r.location },
                                { header: 'التاريخ', render: r => new Date(r.coverage_date).toLocaleDateString('ar-SA') },
                                { header: 'الوردية', render: r => r.shift_details },
                                { header: 'المبلغ', render: r => `${r.payout_amount} ريال` },
                                { header: 'الحالة', render: r => r.status === 'Available' ? 'متاحة' : `مأخوذة (${r.assigned_guard_name || 'غير محدد'})` },
                                { header: 'الإجراءات', render: r => `<div class="flex gap-2">
                                      <button class="action-btn bg-yellow-500 hover:bg-yellow-600 edit-coverage-site-btn" data-site-id="${r.id}"><i class="ph ph-pencil-simple"></i> تعديل</button>
                                      <button class="action-btn bg-red-600 hover:bg-red-700 delete-coverage-site-btn" data-site-id="${r.id}"><i class="ph ph-trash"></i> حذف</button>
                                      </div>` }
                            ];
                            renderTable(tableContainer, columns, covSites);
                        }
                        break;
                    case 'coverage_applicants':
                        const { data: apps, error: appsErr } = await _supabase
                            .from('coverage_applications')
                            .select('*, coverage_guards(*), coverages(*)')
                            .eq('status', 'Pending');
                        if (appsErr) showAlert('فشل تحميل طلبات التقديم.');
                        else {
                             columns = [
                                { header: 'اسم الحارس', render: r => r.coverage_guards.name },
                                { header: 'رقم الهوية', render: r => r.coverage_guards.id },
                                { header: 'تفاصيل التغطية', render: r => `${r.coverages.project} - ${r.coverages.location} (${new Date(r.coverages.coverage_date).toLocaleDateString('ar-SA')})` },
                                { header: 'ملاحظات', render: r => r.notes || '-' },
                                { header: 'الإجراءات', render: r => `<div class="flex gap-2">
                                      <button class="action-btn bg-green-600 hover:bg-green-700 accept-coverage-app-btn" data-app-id="${r.id}" data-coverage-id="${r.coverage_id}" data-guard-id="${r.guard_id}" data-guard-name="${r.coverage_guards.name}"><i class="ph ph-check"></i> قبول</button>
                                      <button class="action-btn bg-red-600 hover:bg-red-700 reject-coverage-app-btn" data-app-id="${r.id}"><i class="ph ph-x"></i> رفض</button>
                                      <button class="action-btn bg-gray-600 hover:bg-gray-700 delete-coverage-app-btn" data-app-id="${r.id}"><i class="ph ph-trash"></i> حذف</button>
                                      </div>` }
                            ];
                            renderTable(tableContainer, columns, apps);
                        }
                        break;
                    case 'salaries':
                        const [attRes, finRes] = await Promise.all([
                             _supabase.from('attendance').select('*'),
                             _supabase.from('financial_transactions').select('*')
                        ]);
                        if (attRes.error || finRes.error) { showLoading(false); return showAlert('فشل تحميل البيانات المالية.'); }
                        const attendanceRecords = attRes.data;
                        const financialTransactions = finRes.data;

                        const salaryData = state.allGuardsData.map(guard => {
                            const guardAttendance = attendanceRecords.filter(r => r.guard_id === guard.id && r.status === 'Approved');
                            const guardTransactions = financialTransactions.filter(t => t.guard_id === guard.id);
                            
                            const totalEntitlement = guardAttendance.reduce((acc, curr) => acc + (curr.daily_entitlement || 0), 0);
                            const totalDeductions = guardTransactions.filter(t => t.type === 'deduction').reduce((acc, curr) => acc + curr.amount, 0);
                            const totalAdditions = guardTransactions.filter(t => t.type === 'addition').reduce((acc, curr) => acc + curr.amount, 0);
                            const totalLoans = guardTransactions.filter(t => t.type === 'loan').reduce((acc, curr) => acc + curr.amount, 0); // Assuming loans are also deductions

                            const netSalary = totalEntitlement - totalDeductions - totalLoans + totalAdditions;

                            return { ...guard, totalEntitlement, totalDeductions, totalAdditions, netSalary };
                        });
                        
                        columns = [
                            { header: 'اسم الحارس', render: r => r.name },
                            { header: 'المستحق الشهري', render: r => `<span class="text-green-400">${r.totalEntitlement.toFixed(2)} ريال</span>` },
                            { header: 'الخصومات', render: r => `<span class="text-red-400">${r.totalDeductions.toFixed(2)} ريال</span>` },
                            { header: 'الإضافات', render: r => `<span class="text-blue-400">${r.totalAdditions.toFixed(2)} ريال</span>` },
                            { header: 'صافي الراتب', render: r => `<span class="font-bold text-lg">${r.netSalary.toFixed(2)} ريال</span>` },
                            { header: 'إجراءات مالية', render: r => `<div class="flex gap-2">
                                  <button class="action-btn bg-red-500 hover:bg-red-600 financial-btn" data-guard-id="${r.id}" data-type="deduction"><i class="ph ph-minus-circle"></i> خصم</button>
                                  <button class="action-btn bg-green-500 hover:bg-green-600 financial-btn" data-guard-id="${r.id}" data-type="addition"><i class="ph ph-plus-circle"></i> زيادة</button>
                                  </div>` 
                            }
                        ];
                        renderTable(tableContainer, columns, salaryData);
                        break;
                    case 'hr_staff':
                    case 'supervisors':
                    case 'operations':
                        const rolesMap = { hr_staff: 'hr', supervisors: 'admin', operations: 'operations' };
                        const role = rolesMap[tab];
                        ({data, error} = await _supabase.from('staff').select('*').eq('role', role));
                        columns = [ { header: 'الاسم', render: r => r.name }, { header: 'المسمى الوظيفي', render: r => r.job_title || '-' }, { header: 'اسم المستخدم', render: r => r.username }, { header: 'الإجراءات', render: r => `<div class="flex gap-2"><button class="action-btn bg-yellow-500 hover:bg-yellow-600 edit-staff-btn" data-staff-id="${r.id}"><i class="ph ph-pencil-simple"></i> تعديل</button><button class="action-btn bg-red-600 hover:bg-red-700 delete-staff-btn" data-staff-id="${r.id}" data-staff-name="${r.name}"><i class="ph ph-trash"></i> حذف</button></div>` }];
                        renderTable(tableContainer, columns, data);
                        break;
                    
                    case 'transfers':
                        ({ data, error } = await _supabase.from('transfer_requests').select('*').order('created_at', { ascending: false }));
                        columns = [
                            { header: 'اسم الحارس', render: r => r.guard_name },
                            { header: 'من مشروع', render: r => r.current_project },
                            { header: 'إلى موقع', render: r => r.new_location },
                            { header: 'إلى مشروع', render: r => r.new_project },
                            { header: 'مقدم الطلب', render: r => r.from_supervisor_name },
                            { header: 'الحالة', render: r => {
                                let statusText = r.status;
                                let color = 'text-yellow-400';
                                if (r.status === 'Approved') { statusText = 'معتمد'; color = 'text-green-400'; }
                                if (r.status === 'Rejected') { statusText = 'مرفوض'; color = 'text-red-400'; }
                                return `<span class="font-bold ${color}">${statusText}</span>
                                      <span class="text-xs text-gray-400 block">بواسطة: ${r.processed_by || '-'}</span>
                                      ${r.rejection_reason ? `<span class="text-xs text-red-300 block">سبب الرفض: ${r.rejection_reason}</span>` : ''}`;
                            }}
                        ];
                        renderTable(tableContainer, columns, data);
                        break;

                    case 'leaves': 
                    case 'loans':
                    case 'resignations':
                        const requestTypeMap = { leaves: 'leave_requests', loans: 'loan_requests', resignations: 'resignation_requests' };
                        const tableName = requestTypeMap[tab];
                        ({ data, error } = await _supabase.from(tableName).select('*').order('created_at', { ascending: false }));
                        columns = [ 
                            { header: 'اسم الحارس', render: r => r.guard_name },
                            { header: 'رقم الهوية', render: r => { const guard = state.allGuardsData.find(g => g.id === r.guard_id); return guard?.id || '-'; } },
                            { header: 'التفاصيل', render: r => {
                                if(tableName === 'leave_requests') return `طلب ${r.days_requested} يوم`;
                                if(tableName === 'loan_requests') return `طلب ${r.amount_requested} ريال`;
                                return r.reason.substring(0, 50) + '...';
                            }}, 
                            { header: 'الحالة', render: r => r.status || 'Pending'}, 
                            { header: 'الإجراءات', render: r => {
                                const currentStatus = r.status || 'Pending';
                                if (currentStatus === 'Approved' && tableName === 'leave_requests') {
                                    return `<div class="flex gap-2">
                                                <span class="font-bold text-green-400">معتمد</span>
                                                <button class="action-btn bg-orange-600 hover:bg-orange-700 cancel-leave-btn" data-id="${r.id}" data-table="${tableName}"><i class="ph ph-x-circle"></i> قطع</button>
                                            </div>`;
                                }
                                if (currentStatus !== 'Pending') return `<span class="font-bold ${currentStatus === 'Approved' ? 'text-green-400' : 'text-red-400'}">${currentStatus === 'Approved' ? 'معتمد' : 'مرفوض'}</span>`;
                                return `<div class="flex gap-2"> 
                                      <button class="action-btn bg-green-600 hover:bg-green-700 hr-action-btn" data-id="${r.id}" data-table="${tableName}" data-action="Approved"><i class="ph ph-check"></i> موافقة</button>
                                      <button class="action-btn bg-red-600 hover:bg-red-700 hr-action-btn" data-id="${r.id}" data-table="${tableName}" data-action="Rejected"><i class="ph ph-x"></i> رفض</button>
                                      <button class="action-btn bg-gray-600 hover:bg-gray-700 delete-record-btn" data-id="${r.id}" data-table="${tableName}"><i class="ph ph-trash"></i> حذف</button> 
                                      </div>`;
                            }}
                        ];
                        renderTable(tableContainer, columns, data);
                        break;
                    case 'logs':
                        ({ data, error } = await _supabase.from('activity_log').select('*').order('created_at', { ascending: false }));
                        columns = [ { header: 'المنفذ', render: r => r.actor }, { header: 'الإجراء', render: r => r.action }, { header: 'التفاصيل', render: r => r.details }, { header: 'الوقت', render: r => new Date(r.created_at).toLocaleString('ar-SA') } ];
                        renderTable(tableContainer, columns, data);
                        break;
                }
                showLoading(false);
                if(error) return showAlert('فشل تحميل البيانات.');
            };

            const logout = () => { sessionStorage.clear(); state = { currentGuard: null, currentUser: null, currentRole: null, allGuardsData: [], activeAttendanceId: null }; showPage('landing-page'); };
            
            const checkSession = () => {
                const guard = sessionStorage.getItem('arkanatGuard'); 
                const user = sessionStorage.getItem('arkanatUser');
                const role = sessionStorage.getItem('arkanatRole');
                const coverageGuard = sessionStorage.getItem('arkanatCoverageGuard');

                if (coverageGuard) {
                    state.currentGuard = JSON.parse(coverageGuard);
                    state.currentRole = 'coverage_guard';
                    loadCoverageGuardDashboard();
                } else if (guard) { 
                    state.currentGuard = JSON.parse(guard); 
                    dom.guardNameDisplay.textContent = state.currentGuard.name; 
                    showPage('guard-dashboard-page'); 
                    updateGuardButtonState(state.currentGuard.id); 
                } else if (user && role) { 
                    state.currentUser = JSON.parse(user); 
                    state.currentRole = role; 
                    if (role === 'hr') loadHrDashboard(); 
                    else loadAdminDashboard(); 
                } else { 
                    showPage('landing-page'); 
                }
            };
            
            const exportTableToCSV = (tableSelector, filename) => {
                const table = document.querySelector(tableSelector);
                if (!table) {
                    showAlert('لا يوجد جدول لتصديره.');
                    return;
                }
                let csv = [];
                const rows = table.querySelectorAll("tr");
                
                for (const row of rows) {
                    const cols = row.querySelectorAll("td, th");
                    const rowData = [];
                    for (const col of cols) {
                        // Get text content, remove extra whitespace and commas.
                        let data = col.innerText.replace(/(\r\n|\n|\r)/gm, " ").replace(/,/g, ";").trim();
                        // Handle buttons inside cells
                        if (col.querySelector('button')) {
                            const buttonTexts = Array.from(col.querySelectorAll('button')).map(btn => btn.textContent.trim());
                            data = buttonTexts.join(' / ');
                        }
                        rowData.push(`"${data}"`);
                    }
                    csv.push(rowData.join(","));
                }

                const csvFile = new Blob(["\uFEFF" + csv.join("\n")], { type: "text/csv;charset=utf-8;" });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(csvFile);
                link.download = filename || 'export.csv';
                link.click();
            }

            const setupEventListeners = () => {
                document.querySelectorAll('.login-option-card').forEach(b => b.addEventListener('click', (e) => { 
                    state.currentRole = e.currentTarget.dataset.role; 
                    const isStaff = ['admin', 'operations', 'hr'].includes(state.currentRole);
                    document.querySelector('#login-page label[for="login-id"]').textContent = isStaff ? 'اسم المستخدم' : 'رقم الهوية';
                    dom.loginTitle.textContent = { guard: 'تسجيل دخول الحارس', coverage_guard: 'دخول حراس التغطيات', admin: 'دخول المشرف', operations: 'دخول إدارة العمليات', hr: 'دخول الموارد البشرية' }[state.currentRole];
                    showPage('login-page'); 
                }));

                document.getElementById('login-btn').addEventListener('click', async () => {
                    const id = document.getElementById('login-id').value.trim(); 
                    const pass = document.getElementById('login-password').value.trim(); 
                    if (!id || !pass) return showAlert("يرجى إدخال البيانات."); 
                    showLoading(true);

                    if (state.currentRole === 'guard') {
                         const { data, error } = await _supabase.from('guards').select('*').eq('id', id).single(); 
                         if (error || !data) { showAlert("رقم الهوية غير صحيح."); }
                         else if (data.password === pass) { 
                             state.currentGuard = data; 
                             sessionStorage.setItem('arkanatGuard', JSON.stringify(data)); 
                             dom.guardNameDisplay.textContent = state.currentGuard.name; 
                             showPage('guard-dashboard-page'); 
                             await updateGuardButtonState(state.currentGuard.id); 
                         } else { showAlert("كلمة المرور غير صحيحة."); }
                    } else if (state.currentRole === 'coverage_guard') {
                        const { data, error } = await _supabase.from('coverage_guards').select('*').eq('id', id).single();
                        if (error || !data) { showAlert("رقم الهوية غير صحيح."); }
                        else if (data.password === pass) {
                            state.currentGuard = data; // Use the same state property for simplicity
                            state.currentRole = 'coverage_guard';
                            sessionStorage.setItem('arkanatCoverageGuard', JSON.stringify(data));
                            loadCoverageGuardDashboard();
                        } else { showAlert("كلمة المرور غير صحيحة."); }
                    } else { // Admin, Ops, HR
                        if (id === 'admin' && pass === 'admin') {
                            const superAdminUser = { name: 'Super Admin', role: 'hr' };
                            state.currentUser = superAdminUser; state.currentRole = 'hr';
                            sessionStorage.setItem('arkanatUser', JSON.stringify(superAdminUser));
                            sessionStorage.setItem('arkanatRole', 'hr');
                            loadHrDashboard();
                        } else {
                            const { data, error } = await _supabase.from('staff').select('*').eq('username', id).eq('role', state.currentRole).single();
                            if (error || !data) { showAlert("اسم المستخدم غير صحيح أو ليس لديه الصلاحية."); }
                            else if (data.password === pass) { 
                                state.currentUser = data; 
                                sessionStorage.setItem('arkanatUser', JSON.stringify(data)); 
                                sessionStorage.setItem('arkanatRole', data.role); 
                                if (data.role === 'hr') loadHrDashboard(); 
                                else loadAdminDashboard(); 
                            } else { showAlert("كلمة المرور غير صحيحة."); }
                        }
                    }
                    showLoading(false);
                });

                document.getElementById('guard-buttons-container').addEventListener('click', (e) => {
                    const button = e.target.closest('button');
                    if (!button) return;
                    
                    if (button.id === 'check-in-btn') {
                        if (!button.disabled) {
                            showModal('attendance-modal');
                            document.getElementById('guard-notes').value = '';
                        }
                    } else if (button.id === 'check-out-btn') {
                         if (!button.disabled) dom.checkOutBtn.dispatchEvent(new Event('checkout'));
                    } else if (button.classList.contains('request')) {
                        showModal(button.dataset.modal);
                    }
                });
                
                document.getElementById('submit-attendance-btn').addEventListener('click', async () => {
                    showLoading(true); 
                    let coords = {};
                    try {
                        const position = await getGeolocation();
                        coords = { checkin_lat: position.latitude, checkin_lon: position.longitude };
                    } catch (geoError) {
                        showAlert('لم نتمكن من تحديد موقعك. سيتم تسجيل الحضور بدون موقع.');
                    }

                    try {
                        const payload = { 
                            guard_id: state.currentGuard.id, 
                            guard_name: state.currentGuard.name, 
                            notes: document.getElementById('guard-notes').value.trim(), 
                            status: 'Pending',
                            ...coords 
                        };
                        const { data, error } = await _supabase.from('attendance').insert(payload).select().single();
                        closeModal();
                        if (error) throw error;
                        await logActivity(`الحارس: ${state.currentGuard.name}`, 'قام بتسجيل الحضور', `رقم السجل: ${data?.id}`);
                        showAlert("تم تسجيل حضورك بنجاح!"); 
                        await updateGuardButtonState(state.currentGuard.id); 
                    } catch (error) {
                        showAlert(`فشل تسجيل الحضور: ${error.message}`);
                    } finally {
                        showLoading(false);
                    }
                });
                
                if (dom.checkOutBtn) {
                    dom.checkOutBtn.addEventListener('checkout', async () => {
                        if (dom.checkOutBtn.disabled || !state.activeAttendanceId) return; 
                        if (!await confirmAction('تأكيد الانصراف', 'هل أنت متأكد من رغبتك في الانصراف الآن؟')) return; 
                        showLoading(true);
                        let coords = {};
                        try {
                            const position = await getGeolocation();
                            coords = { checkout_lat: position.latitude, checkout_lon: position.longitude };
                        } catch (geoError) {
                            showAlert('لم نتمكن من تحديد موقعك. سيتم تسجيل الانصراف بدون موقع.');
                        }
                        try {
                            await fetchAllGuards();
                            const checkoutTime = new Date();
                            const {data: attendanceRecord, error: fetchError} = await _supabase.from('attendance').select('created_at').eq('id', state.activeAttendanceId).single();
                            if (fetchError || !attendanceRecord) { throw new Error('لم يتم العثور على سجل الحضور النشط.'); }
                            const workDurationMs = checkoutTime - new Date(attendanceRecord.created_at);
                            const durationString = formatDuration(workDurationMs);
                            const currentGuardData = state.allGuardsData.find(g => g.id === state.currentGuard.id);
                            const entitlement = calculateEntitlement(currentGuardData, workDurationMs);
                            
                            const updatePayload = { 
                                checkout_at: checkoutTime.toISOString(), 
                                work_duration: durationString, 
                                daily_entitlement: entitlement,
                                ...coords
                            };

                            const { error } = await _supabase.from('attendance').update(updatePayload).eq('id', state.activeAttendanceId);
                            if(error) throw error;
                            await logActivity(`الحارس: ${state.currentGuard.name}`, 'قام بالانصراف', `مدة العمل: ${durationString}`);
                            showAlert("تم تسجيل انصرافك بنجاح."); await updateGuardButtonState(state.currentGuard.id);
                        } catch (error) {
                            showAlert(`فشل الانصراف: ${error.message}`);
                        } finally {
                            showLoading(false);
                        }
                    });
                }

                const handleGuardRequest = async (tableName, payload, successMsg, logAction, logDetails) => {
                    showLoading(true);
                    const { error } = await _supabase.from(tableName).insert(payload);
                    if (error) {
                        console.error(`Error submitting request to ${tableName}:`, error);
                        showLoading(false);
                        closeModal();
                        showAlert('فشل إرسال الطلب');
                        return;
                    }
                    await logActivity(`الحارس: ${state.currentGuard.name}`, logAction, logDetails);
                    showLoading(false);
                    closeModal();
                    showAlert(successMsg);
                };

                document.getElementById('submit-leave-btn').addEventListener('click', () => { const days = document.getElementById('leave-days').value; const reason = document.getElementById('leave-reason').value.trim(); if(!days || !reason) return showAlert('يرجى ملء كل الحقول.'); handleGuardRequest('leave_requests', { guard_id: state.currentGuard.id, guard_name: state.currentGuard.name, days_requested: days, reason, status: 'Pending' }, "تم إرسال طلب الإجازة بنجاح.", 'قدم طلب إجازة', `لمدة ${days} يوم`); });
                document.getElementById('submit-loan-btn').addEventListener('click', () => { const amount = document.getElementById('loan-amount').value; const reason = document.getElementById('loan-reason').value.trim(); if(!amount || !reason) return showAlert('يرجى ملء كل الحقول.'); handleGuardRequest('loan_requests', { guard_id: state.currentGuard.id, guard_name: state.currentGuard.name, amount_requested: amount, reason, status: 'Pending' }, "تم إرسال طلب السلفة بنجاح.", 'قدم طلب سلفة', `بمبلغ ${amount} ريال`); });
                document.getElementById('submit-permission-btn').addEventListener('click', () => { const reason = document.getElementById('permission-reason').value.trim(); if(!reason) return showAlert('يرجى ذكر السبب.'); handleGuardRequest('permission_requests', { guard_id: state.currentGuard.id, guard_name: state.currentGuard.name, reason, status: 'Pending' }, "تم إرسال طلب الإستئذان بنجاح.", 'قدم طلب استئذان', `السبب: ${reason}`); });
                document.getElementById('submit-overtime-btn').addEventListener('click', () => { const reason = document.getElementById('overtime-reason').value.trim(); if(!reason) return showAlert('يرجى ذكر التفاصيل.'); handleGuardRequest('overtime_requests', { guard_id: state.currentGuard.id, guard_name: state.currentGuard.name, reason, status: 'Pending' }, "تم إرسال طلب العمل الإضافي بنجاح.", 'قدم طلب عمل إضافي', `السبب: ${reason}`); });
                document.getElementById('submit-resignation-btn').addEventListener('click', () => { const reason = document.getElementById('resignation-reason').value.trim(); if(!reason) return showAlert('يرجى ذكر السبب.'); handleGuardRequest('resignation_requests', { guard_id: state.currentGuard.id, guard_name: state.currentGuard.name, reason, status: 'Pending' }, "تم إرسال طلب الاستقالة.", 'قدم طلب استقالة', `السبب: ${reason}`); });
                
                // Initialize HR Tabs
                const hrTabsContainer = dom.hrTabs;
                if(hrTabsContainer){
                    hrTabsContainer.innerHTML = `
                        <a href="#" data-tab="guards" class="custom-tab">الحراس</a>
                        <a href="#" data-tab="salaries" class="custom-tab">الرواتب</a>
                        <a href="#" data-tab="hr_staff" class="custom-tab">الموارد البشرية</a>
                        <a href="#" data-tab="supervisors" class="custom-tab">المشرفون</a>
                        <a href="#" data-tab="operations" class="custom-tab">العمليات</a>
                        <a href="#" data-tab="coverage_recruitment" class="custom-tab">توظيف تغطيات</a>
                        <a href="#" data-tab="coverage_sites" class="custom-tab">إدارة التغطيات</a>
                        <a href="#" data-tab="coverage_applicants" class="custom-tab">مقدمين التغطيات</a>
                        <a href="#" data-tab="transfers" class="custom-tab">نقل الحراس</a>
                        <a href="#" data-tab="leaves" class="custom-tab">الإجازات</a>
                        <a href="#" data-tab="loans" class="custom-tab">السلف</a>
                        <a href="#" data-tab="resignations" class="custom-tab">الاستقالات</a>
                        <a href="#" data-tab="logs" class="custom-tab">السجل</a>
                    `;
                    hrTabsContainer.addEventListener('click', e => { e.preventDefault(); if(e.target.closest('.custom-tab')) loadHrDashboard(e.target.closest('.custom-tab').dataset.tab); });
                }

                // Consolidated click listener for dynamically added buttons
                document.body.addEventListener('click', async (e) => {
                    const button = e.target.closest('button');
                    if (!button) return;

                    // Logout Button
                    if (button.classList.contains('logout-btn')) {
                        logout();
                    }

                    // Add Guard Button (HR Dashboard)
                    if(button.id === 'add-guard-btn') {
                        document.getElementById('guard-form-title-text').textContent = 'إضافة حارس جديد';
                        document.getElementById('guard-form-id').value = '';
                        document.getElementById('guard-form-national-id').value = '';
                        document.getElementById('guard-form-name').value = '';
                        document.getElementById('guard-form-mobile').value = '';
                        document.getElementById('guard-form-password').value = '';
                        document.getElementById('guard-form-job-title').value = '';
                        document.getElementById('guard-form-location').value = '';
                        document.getElementById('guard-form-region').value = '';
                        document.getElementById('guard-form-project').value = '';
                        document.getElementById('guard-form-status').value = 'اساسي';
                        document.getElementById('guard-form-basic-salary').value = '';
                        document.getElementById('guard-form-housing-allowance').value = '';
                        document.getElementById('guard-form-transport-allowance').value = '';
                        document.getElementById('guard-form-other-allowances').value = '';
                        document.getElementById('guard-form-national-id').disabled = false;
                        const scheduleContainer = document.getElementById('guard-form-schedule-container');
                        const days = { sunday: 'الأحد', monday: 'الإثنين', tuesday: 'الثلاثاء', wednesday: 'الأربعاء', thursday: 'الخميس', friday: 'الجمعة', saturday: 'السبت' };
                        scheduleContainer.innerHTML = Object.entries(days).map(([dayKey, dayName]) => `
                            <div class="grid grid-cols-5 gap-2 items-center">
                                <label class="col-span-1 text-gray-300">${dayName}</label>
                                <label class="text-xs text-center">من</label>
                                <input type="time" data-day="${dayKey}" data-type="start" class="col-span-1 p-1 bg-slate-700 border border-slate-600 rounded-md">
                                <label class="text-xs text-center">إلى</label>
                                <input type="time" data-day="${dayKey}" data-type="end" class="col-span-1 p-1 bg-slate-700 border border-slate-600 rounded-md">
                            </div>`).join('');
                        showModal('guard-form-modal');
                    }
                    
                    // Add Staff Button (HR Dashboard)
                    if(button.id === 'add-staff-btn') {
                          const role = button.dataset.role;
                          const roleNames = { 'hr': 'موظف موارد بشرية', 'admin': 'مشرف', 'operations': 'موظف عمليات'};
                          document.getElementById('staff-form-title').textContent = `إضافة ${roleNames[role]} جديد`;
                          document.getElementById('staff-form-id').value = '';
                          document.getElementById('staff-form-role').value = role;
                          document.getElementById('staff-form-name').value = '';
                          document.getElementById('staff-form-username').value = '';
                          document.getElementById('staff-form-username').disabled = false;
                          document.getElementById('staff-form-password').value = '';
                          document.getElementById('staff-form-title-input').value = '';
                          document.getElementById('staff-form-title-container').style.display = role === 'hr' ? 'block' : 'none';
                          document.getElementById('staff-form-assignment-container').style.display = (role === 'admin' || role === 'operations') ? 'block' : 'none';
                          document.getElementById('staff-form-assignments-list').innerHTML = '';
                          addAssignmentRow();
                          showModal('staff-form-modal');
                    }

                    // Add Assignment Row Button (Staff Modal)
                    if(button.id === 'add-assignment-btn'){
                        addAssignmentRow();
                    }
                    
                    // Transfer Request Button (Admin Dashboard)
                    if(button.id === 'transfer-request-btn') {
                        await fetchAllGuards();
                        const selectEl = document.getElementById('transfer-guard-select');
                        const supervisorAssignments = state.currentUser.assignments || [];
                        const assignedGuards = state.allGuardsData.filter(guard => {
                           return supervisorAssignments.some(asn => 
                            (!asn.region || asn.region === guard.region) &&
                            (!asn.location || asn.location === guard.location) &&
                            (!asn.project || asn.project === guard.project)
                           );
                        });
                        selectEl.innerHTML = assignedGuards.map(g => `<option value="${g.id}" data-project="${g.project}">${g.name} - ${g.project}</option>`).join('');
                        showModal('transfer-request-modal');
                    }
                    
                    // Export CSV Button (Admin Dashboard)
                    if(button.id === 'admin-export-csv-btn' || button.id === 'hr-export-csv-btn') {
                        const targetTableSelector = button.dataset.targetTable;
                        const activeTab = document.querySelector('.custom-tab.active-tab')?.dataset.tab || 'export';
                        const filename = `Arkanat-${activeTab}-${new Date().toISOString().split('T')[0]}.csv`;
                        exportTableToCSV(targetTableSelector, filename);
                    }
                });
                
                if (dom.coverageGuardTabContent) {
                    dom.coverageGuardTabContent.addEventListener('click', async (e) => {
                         const button = e.target.closest('.apply-for-coverage-btn');
                         if(!button || button.disabled) return;

                         const coverageId = button.dataset.coverageId;
                         document.getElementById('coverage-notes-coverage-id').value = coverageId;
                         document.getElementById('coverage-notes-textarea').value = '';
                         showModal('coverage-notes-modal');
                    });
                }
                
                if (document.getElementById('submit-coverage-notes-btn')) {
                    document.getElementById('submit-coverage-notes-btn').addEventListener('click', async () => {
                        const coverageId = document.getElementById('coverage-notes-coverage-id').value;
                        const notes = document.getElementById('coverage-notes-textarea').value.trim();

                        showLoading(true);
                         const { error } = await _supabase.from('coverage_applications').insert({
                             coverage_id: coverageId,
                             guard_id: state.currentGuard.id,
                             status: 'Pending',
                             notes: notes || null
                         });
                         showLoading(false);
                         closeModal();

                         if(error) {
                             if (error.message.includes('unique_application')) {
                                 showAlert('لقد قدمت على هذه التغطية بالفعل.');
                             } else {
                                 showAlert('فشل التقديم على التغطية. الرجاء المحاولة مرة أخرى.');
                                 console.error('Apply for coverage error:', error);
                             }
                         } else {
                             showAlert('تم التقديم بنجاح!');
                             // Reload the tab to update the button state
                             loadCoverageGuardDashboard('available_coverages');
                         }
                    });
                }


                if (dom.adminTabContent) {
                    dom.adminTabContent.addEventListener('click', async (e) => {
                        const button = e.target.closest('button.action-btn');
                        if (!button) return;

                        if (button.classList.contains('view-map-btn')) {
                            const lat = button.dataset.lat;
                            const lon = button.dataset.lon;
                            if (lat && lon) {
                                window.open(`https://www.google.com/maps?q=${lat},${lon}`, '_blank');
                            }
                            return;
                        }

                        const id = button.dataset.id;
                        const currentTab = document.querySelector('#admin-ops-tabs .active-tab').dataset.tab;
                        const role = state.currentRole;

                        // Supervisor manually checks out a guard
                        if (button.classList.contains('supervisor-checkout-btn')) {
                            const attendanceId = button.dataset.attendanceId;
                            const guardId = button.dataset.guardId;
                            const { data: attendanceRecord } = await _supabase.from('attendance').select('guard_name, created_at').eq('id', attendanceId).single();
                            if (!await confirmAction('تأكيد الخروج', `هل أنت متأكد من تسجيل الخروج للحارس ${attendanceRecord.guard_name}؟`)) return;

                            showLoading(true);
                            try {
                                const checkoutTime = new Date();
                                const workDurationMs = checkoutTime - new Date(attendanceRecord.created_at);
                                const guard = state.allGuardsData.find(g => g.id.toString() === guardId);
                                const entitlement = calculateEntitlement(guard, workDurationMs);
                                await _supabase.from('attendance').update({
                                    checkout_at: checkoutTime.toISOString(),
                                    work_duration: formatDuration(workDurationMs),
                                    daily_entitlement: entitlement,
                                    action_by: state.currentUser.name
                                }).eq('id', attendanceId);
                                await logActivity(state.currentUser.name, 'قام بتسجيل خروج للحارس', `اسم الحارس: ${attendanceRecord.guard_name}`);
                                showAlert('تم تسجيل الخروج بنجاح. السجل بانتظار الاعتماد.');
                            } catch (error) {
                                showAlert(`حدث خطأ: ${error.message}`);
                            } finally {
                                showLoading(false);
                                loadAdminDashboard(currentTab);
                            }
                            return;
                        }

                        // Approve a PENDING attendance record
                        if (button.classList.contains('approve-attendance-btn')) {
                            if (!await confirmAction('تأكيد الإجراء', `هل أنت متأكد من اعتماد هذا السجل؟`)) return;
                            showLoading(true);
                            const { data: rec, error: fetchError } = await _supabase.from('attendance').select('checkout_at').eq('id', id).single();
                            if (fetchError || !rec) {
                                showLoading(false);
                                showAlert('لم يتم العثور على سجل الحضور.');
                                return;
                            }
                            if (!rec.checkout_at) {
                                showLoading(false);
                                showAlert('لا يمكن اعتماد سجل حضور لم يتم تسجيل الانصراف له بعد.');
                                return;
                            }
                            const { error } = await _supabase.from('attendance').update({ status: 'Approved', action_by: state.currentUser.name }).eq('id', id);
                            showLoading(false);
                            if (error) showAlert(`فشل الاعتماد: ${error.message}`);
                            loadAdminDashboard(currentTab);
                            return;
                        }
                        
                        // Cancel a PENDING attendance record
                        if (button.classList.contains('cancel-attendance-btn')) {
                            if (!await confirmAction('تأكيد الإجراء', `هل أنت متأكد من إلغاء هذا السجل؟`)) return;
                            showLoading(true);
                            const { error } = await _supabase.from('attendance').update({ status: 'Cancelled', action_by: state.currentUser.name }).eq('id', id);
                            showLoading(false);
                            if (error) showAlert(`فشل الإلغاء: ${error.message}`);
                            loadAdminDashboard(currentTab);
                            return;
                        }
                        
                        // Modify a completed attendance record back to pending (Ops only)
                        if (button.classList.contains('modify-attendance-btn') && role === 'operations') {
                            if (!await confirmAction('تأكيد التعديل', `هل أنت متأكد من إعادة هذا السجل إلى حالة "معلق"؟`)) return;
                            showLoading(true);
                            const { error } = await _supabase.from('attendance').update({ 
                                status: 'Pending', 
                                action_by: state.currentUser.name
                            }).eq('id', id);
                            showLoading(false);
                            if (error) showAlert(`فشل التعديل: ${error.message}`);
                            loadAdminDashboard(currentTab);
                            return;
                        }
                        
                        // Approve other request types
                        if (button.classList.contains('approve-request-btn')) {
                            const tableName = button.dataset.type;
                            if (!await confirmAction('تأكيد الإجراء', `هل أنت متأكد من الموافقة على هذا الطلب؟`)) return;
                            showLoading(true);
                            const { error } = await _supabase.from(tableName).update({ status: 'Approved', processed_by: state.currentUser.name }).eq('id', id);
                            showLoading(false);
                            if (error) showAlert('فشلت العملية'); else loadAdminDashboard(currentTab);
                            return;
                        }
                        
                        // Approve a transfer request (Ops only)
                        if (button.classList.contains('approve-transfer-btn') && role === 'operations') {
                            const transferId = button.dataset.id;
                            const guardId = button.dataset.guardId;
                            const newLocation = button.dataset.location;
                            const newProject = button.dataset.project;
                            if (!await confirmAction('تأكيد النقل', `هل توافق على نقل الحارس إلى ${newProject}؟`)) return;

                            showLoading(true);
                            try {
                                const { error: guardError } = await _supabase.from('guards').update({ location: newLocation, project: newProject }).eq('id', guardId);
                                if (guardError) throw guardError;

                                const { error: transferError } = await _supabase.from('transfer_requests').update({ status: 'Approved', processed_by: state.currentUser.name }).eq('id', transferId);
                                if (transferError) throw transferError;
                                
                                showAlert('تمت الموافقة على النقل بنجاح.');
                            } catch(error) {
                                showAlert(`حدث خطأ أثناء عملية النقل: ${error.message}`);
                            } finally {
                                showLoading(false);
                                loadAdminDashboard(currentTab);
                            }
                            return;
                        }

                        // Reject ANY request type
                        if (button.classList.contains('reject-request-btn')) {
                            const tableName = button.dataset.type;
                            if (tableName === 'transfer_requests') {
                                document.getElementById('rejection-item-id').value = id;
                                document.getElementById('rejection-table-name').value = tableName;
                                document.getElementById('rejection-reason-input').value = '';
                                showModal('rejection-reason-modal');
                            } else {
                                if (!await confirmAction('تأكيد الإجراء', `هل أنت متأكد من رفض هذا الطلب؟`)) return;
                                showLoading(true);
                                const { error } = await _supabase.from(tableName).update({ status: 'Rejected', processed_by: state.currentUser.name }).eq('id', id);
                                showLoading(false);
                                if (error) showAlert('فشلت العملية'); else loadAdminDashboard(currentTab);
                            }
                            return;
                        }
                    });
                }

                if (dom.hrTabContent) {
                    dom.hrTabContent.addEventListener('click', async(e) => {
                        const button = e.target.closest('button');
                        if (!button) return;

                        const currentTab = dom.hrTabs.querySelector('.active-tab').dataset.tab;

                        if (button.classList.contains('hr-action-btn')) {
                            const id = button.dataset.id;
                            const tableName = button.dataset.table;
                            const action = button.dataset.action; // 'Approved' or 'Rejected'
                            const actionText = action === 'Approved' ? 'الموافقة' : 'الرفض';
                            if (!await confirmAction(`تأكيد ${actionText}`, `هل أنت متأكد من ${actionText} على هذا الطلب؟`)) return;
                            showLoading(true);
                            const { error } = await _supabase.from(tableName).update({ status: action, processed_by: 'HR' }).eq('id', id);
                            showLoading(false);
                            if (error) {
                                showAlert(`فشلت عملية ${actionText}: ${error.message}`);
                            } else {
                                showAlert(`تمت عملية ${actionText} بنجاح.`);
                                await logActivity('HR', `${actionText} طلب`, `Table: ${tableName}, ID: ${id}`);
                                loadHrDashboard(currentTab);
                            }
                        }
                        else if (button.classList.contains('delete-record-btn')) {
                             const id = button.dataset.id;
                             const tableName = button.dataset.table;
                             if (!await confirmAction('تأكيد الحذف', 'هل أنت متأكد من حذف هذا السجل بشكل نهائي؟')) return;
                             showLoading(true);
                             const { error } = await _supabase.from(tableName).delete().eq('id', id);
                             showLoading(false);
                             if (error) {
                                 showAlert(`فشل الحذف: ${error.message}`);
                             } else {
                                 showAlert('تم حذف السجل بنجاح.');
                                 await logActivity('HR', 'حذف سجل', `Table: ${tableName}, ID: ${id}`);
                                 loadHrDashboard(currentTab);
                             }
                        }
                        else if (button.classList.contains('cancel-leave-btn')) {
                             const id = button.dataset.id;
                             const tableName = button.dataset.table;
                             if (!await confirmAction('تأكيد قطع الإجازة', 'هل أنت متأكد من قطع هذه الإجازة المعتمدة؟')) return;
                             showLoading(true);
                             const { error } = await _supabase.from(tableName).update({ status: 'Cancelled by HR', processed_by: 'HR' }).eq('id', id);
                              showLoading(false);
                             if (error) {
                                 showAlert(`فشل قطع الإجازة: ${error.message}`);
                             } else {
                                 showAlert('تم قطع الإجازة بنجاح.');
                                 await logActivity('HR', 'قطع إجازة', `Table: ${tableName}, ID: ${id}`);
                                 loadHrDashboard(currentTab);
                             }
                        }
                        else if (button.id === 'add-coverage-guard-btn') {
                            document.getElementById('coverage-guard-form-title').textContent = 'إضافة حارس تغطية جديد';
                            document.getElementById('coverage-guard-form-id').value = '';
                            document.getElementById('coverage-guard-form-national-id').value = '';
                            document.getElementById('coverage-guard-form-name').value = '';
                            document.getElementById('coverage-guard-form-mobile').value = '';
                            document.getElementById('coverage-guard-form-password').value = '';
                            document.getElementById('coverage-guard-form-national-id').disabled = false;
                            showModal('coverage-guard-form-modal');
                        }
                        else if (button.id === 'add-coverage-site-btn') {
                             document.getElementById('coverage-site-form-title').textContent = 'إنشاء تغطية جديدة';
                             document.getElementById('coverage-site-form-id').value = '';
                             document.getElementById('coverage-site-project').value = '';
                             document.getElementById('coverage-site-location').value = '';
                             document.getElementById('coverage-site-date').value = '';
                             document.getElementById('coverage-site-day').value = 'السبت';
                             document.getElementById('coverage-site-start-time').value = '';
                             document.getElementById('coverage-site-end-time').value = '';
                             document.getElementById('coverage-site-payout').value = '';
                             showModal('coverage-site-form-modal');
                        }
                        // Handle coverage application actions
                        else if(button.classList.contains('accept-coverage-app-btn')) {
                            const appId = button.dataset.appId;
                            const coverageId = button.dataset.coverageId;
                            const guardId = button.dataset.guardId;
                            const guardName = button.dataset.guardName;
                            if (!await confirmAction('تأكيد القبول', `هل أنت متأكد من قبول ${guardName} لهذه التغطية؟`)) return;
                            showLoading(true);
                            // Set application to accepted
                            await _supabase.from('coverage_applications').update({ status: 'Accepted' }).eq('id', appId);
                            // Assign guard to coverage
                            await _supabase.from('coverages').update({ status: 'Taken', assigned_guard_id: guardId, assigned_guard_name: guardName }).eq('id', coverageId);
                            // Reject other applications for the same coverage
                            await _supabase.from('coverage_applications').update({ status: 'Rejected' }).eq('coverage_id', coverageId).neq('id', appId);
                            showLoading(false);
                            showAlert('تم قبول الحارس وتعيينه للتغطية بنجاح.');
                            loadHrDashboard('coverage_applicants');
                        }
                        else if(button.classList.contains('reject-coverage-app-btn')) {
                            const appId = button.dataset.appId;
                            if (!await confirmAction('تأكيد الرفض', 'هل أنت متأكد من رفض هذا الطلب؟')) return;
                            showLoading(true);
                            await _supabase.from('coverage_applications').update({ status: 'Rejected' }).eq('id', appId);
                            showLoading(false);
                            loadHrDashboard('coverage_applicants');
                        }
                        else if(button.classList.contains('delete-coverage-app-btn')) {
                            const appId = button.dataset.appId;
                            if (!await confirmAction('تأكيد الحذف', 'هل أنت متأكد من حذف طلب التقديم هذا؟')) return;
                            showLoading(true);
                            await _supabase.from('coverage_applications').delete().eq('id', appId);
                            showLoading(false);
                            loadHrDashboard('coverage_applicants');
                        }
                        else if (button.classList.contains('edit-guard-btn')) {
                            const guardId = button.dataset.guardId;
                            const guardData = state.allGuardsData.find(g => g.id.toString() === guardId);
                            if (!guardData) return showAlert('لم يتم العثور على بيانات الحارس.');

                            document.getElementById('guard-form-title-text').textContent = `تعديل بيانات: ${guardData.name}`;
                            document.getElementById('guard-form-id').value = guardData.id;
                            document.getElementById('guard-form-national-id').value = guardData.id;
                            document.getElementById('guard-form-national-id').disabled = true; // Prevent editing PK
                            document.getElementById('guard-form-name').value = guardData.name || '';
                            document.getElementById('guard-form-mobile').value = guardData.mobile_number || '';
                            document.getElementById('guard-form-password').value = '';
                            document.getElementById('guard-form-password').placeholder = 'اتركه فارغاً لعدم التغيير';
                            document.getElementById('guard-form-job-title').value = guardData.job_title || '';
                            document.getElementById('guard-form-location').value = guardData.location || '';
                            document.getElementById('guard-form-region').value = guardData.region || '';
                            document.getElementById('guard-form-project').value = guardData.project || '';
                            document.getElementById('guard-form-status').value = guardData.status || 'اساسي';
                            document.getElementById('guard-form-basic-salary').value = guardData.basic_salary || '';
                            document.getElementById('guard-form-housing-allowance').value = guardData.housing_allowance || '';
                            document.getElementById('guard-form-transport-allowance').value = guardData.transport_allowance || '';
                            document.getElementById('guard-form-other-allowances').value = guardData.other_allowances || '';
                            
                            const scheduleContainer = document.getElementById('guard-form-schedule-container');
                            const days = { sunday: 'الأحد', monday: 'الإثنين', tuesday: 'الثلاثاء', wednesday: 'الأربعاء', thursday: 'الخميس', friday: 'الجمعة', saturday: 'السبت' };
                            scheduleContainer.innerHTML = Object.entries(days).map(([dayKey, dayName]) => {
                                const shift = guardData.weekly_schedule ? guardData.weekly_schedule[dayKey] : null;
                                return `
                                <div class="grid grid-cols-5 gap-2 items-center">
                                    <label class="col-span-1 text-gray-300">${dayName}</label>
                                    <label class="text-xs text-center">من</label>
                                    <input type="time" data-day="${dayKey}" data-type="start" class="col-span-1 p-1 bg-slate-700 border border-slate-600 rounded-md" value="${shift?.start || ''}">
                                    <label class="text-xs text-center">إلى</label>
                                    <input type="time" data-day="${dayKey}" data-type="end" class="col-span-1 p-1 bg-slate-700 border border-slate-600 rounded-md" value="${shift?.end || ''}">
                                </div>`
                            }).join('');
                            
                            showModal('guard-form-modal');
                        }
                        else if (button.classList.contains('view-schedule-btn')) {
                             const guardId = button.dataset.guardId;
                             const guardData = state.allGuardsData.find(g => g.id.toString() === guardId);
                             if (!guardData) return showAlert('لم يتم العثور على بيانات الحارس.');
                             
                             dom.scheduleModal.title.textContent = `جدول دوام: ${guardData.name}`;
                             const scheduleBody = dom.scheduleModal.body;
                             const schedule = guardData.weekly_schedule;
                             if (schedule && Object.keys(schedule).length > 0) {
                                const days = { saturday: 'السبت', sunday: 'الأحد', monday: 'الإثنين', tuesday: 'الثلاثاء', wednesday: 'الأربعاء', thursday: 'الخميس', friday: 'الجمعة' };
                                scheduleBody.innerHTML = `<ul class="space-y-2">` + Object.entries(days).map(([dayKey, dayName]) => {
                                    const shift = schedule[dayKey];
                                    const shiftText = (shift && shift.start && shift.end) 
                                        ? `من ${new Date(`1970-01-01T${shift.start}`).toLocaleTimeString('ar-SA', {hour: '2-digit', minute:'2-digit'})} إلى ${new Date(`1970-01-01T${shift.end}`).toLocaleTimeString('ar-SA', {hour: '2-digit', minute:'2-digit'})}` 
                                        : 'راحة';
                                    return `<li class="flex justify-between"><strong>${dayName}:</strong> <span>${shiftText}</span></li>`;
                                }).join('') + `</ul>`;
                             } else {
                                scheduleBody.innerHTML = '<p class="text-center text-gray-400">لا يوجد جدول مسجل لهذا الحارس.</p>';
                             }
                             showModal('schedule-display-modal');
                        }
                        else if (button.classList.contains('delete-guard-btn')) {
                             const guardId = button.dataset.guardId;
                             const guardName = button.dataset.guardName;
                             if (!await confirmAction('تأكيد الحذف', `هل أنت متأكد من حذف الحارس ${guardName}؟ سيتم حذف جميع سجلاته.`)) return;
                             showLoading(true);
                             const { error } = await _supabase.from('guards').delete().eq('id', guardId);
                             showLoading(false);
                             if (error) {
                                 showAlert(`فشل الحذف: ${error.message}`);
                             } else {
                                 showAlert('تم حذف الحارس بنجاح.');
                                 await logActivity('HR', 'حذف حارس', `Guard ID: ${guardId}, Name: ${guardName}`);
                                 loadHrDashboard('guards');
                             }
                        }
                        else if (button.classList.contains('edit-staff-btn')) {
                            const staffId = button.dataset.staffId;
                            const staffData = state.allStaffData.find(s => s.id.toString() === staffId);
                            if (!staffData) return showAlert('لم يتم العثور على بيانات الموظف.');
                            
                            const role = staffData.role;
                            const roleNames = { 'hr': 'موظف موارد بشرية', 'admin': 'مشرف', 'operations': 'موظف عمليات'};
                            document.getElementById('staff-form-title').textContent = `تعديل ${roleNames[role]}`;
                            document.getElementById('staff-form-id').value = staffData.id;
                            document.getElementById('staff-form-role').value = role;
                            document.getElementById('staff-form-name').value = staffData.name || '';
                            document.getElementById('staff-form-username').value = staffData.username || '';
                            document.getElementById('staff-form-username').disabled = true; // Don't allow changing username
                            document.getElementById('staff-form-password').value = '';
                            document.getElementById('staff-form-password').placeholder = 'اتركه فارغاً لعدم التغيير';
                            document.getElementById('staff-form-title-input').value = staffData.job_title || '';

                            document.getElementById('staff-form-title-container').style.display = role === 'hr' ? 'block' : 'none';
                            const assignmentContainer = document.getElementById('staff-form-assignment-container');
                            assignmentContainer.style.display = (role === 'admin' || role === 'operations') ? 'block' : 'none';
                            const assignmentsList = document.getElementById('staff-form-assignments-list');
                            assignmentsList.innerHTML = '';
                            if (staffData.assignments && staffData.assignments.length > 0) {
                                staffData.assignments.forEach(addAssignmentRow);
                            } else {
                                addAssignmentRow();
                            }

                            showModal('staff-form-modal');
                        }
                        else if (button.classList.contains('delete-staff-btn')) {
                            const staffId = button.dataset.staffId;
                            const staffName = button.dataset.staffName;
                            if (!await confirmAction('تأكيد الحذف', `هل أنت متأكد من حذف الموظف ${staffName}؟`)) return;
                            showLoading(true);
                            const { error } = await _supabase.from('staff').delete().eq('id', staffId);
                            showLoading(false);
                            if (error) {
                                showAlert(`فشل الحذف: ${error.message}`);
                            } else {
                                showAlert('تم حذف الموظف بنجاح.');
                                await logActivity('HR', 'حذف موظف', `Staff ID: ${staffId}, Name: ${staffName}`);
                                loadHrDashboard(currentTab);
                            }
                        }
                        else if (button.classList.contains('edit-coverage-guard-btn')) {
                            const guardId = button.dataset.guardId;
                            const guardData = state.allCoverageGuardsData.find(g => g.id.toString() === guardId);
                            if (!guardData) return showAlert('لم يتم العثور على بيانات حارس التغطية.');

                            document.getElementById('coverage-guard-form-title').textContent = `تعديل بيانات: ${guardData.name}`;
                            document.getElementById('coverage-guard-form-id').value = guardData.id;
                            document.getElementById('coverage-guard-form-national-id').value = guardData.id;
                            document.getElementById('coverage-guard-form-national-id').disabled = true;
                            document.getElementById('coverage-guard-form-name').value = guardData.name || '';
                            document.getElementById('coverage-guard-form-mobile').value = guardData.mobile_number || '';
                            document.getElementById('coverage-guard-form-password').value = '';
                            document.getElementById('coverage-guard-form-password').placeholder = 'اتركه فارغاً لعدم التغيير';
                            showModal('coverage-guard-form-modal');
                        }
                        else if (button.classList.contains('delete-coverage-guard-btn')) {
                            const guardId = button.dataset.guardId;
                            const guardName = button.dataset.guardName;
                            if (!await confirmAction('تأكيد الحذف', `هل أنت متأكد من حذف حارس التغطية ${guardName}؟`)) return;
                            showLoading(true);
                            const { error } = await _supabase.from('coverage_guards').delete().eq('id', guardId);
                            showLoading(false);
                            if (error) {
                                showAlert(`فشل الحذف: ${error.message}`);
                            } else {
                                showAlert('تم حذف حارس التغطية بنجاح.');
                                await logActivity('HR', 'حذف حارس تغطية', `Guard ID: ${guardId}, Name: ${guardName}`);
                                loadHrDashboard('coverage_recruitment');
                            }
                        }
                    });
                }
                 // *** NEW: Added button listeners ***
                document.getElementById('login-back-btn').addEventListener('click', () => showPage('landing-page'));
                document.getElementById('alert-close-btn').addEventListener('click', closeModal);
                document.querySelectorAll('.modal-close-btn').forEach(btn => btn.addEventListener('click', closeModal));
            };

            const addAssignmentRow = (assignment = {}) => {
                const list = document.getElementById('staff-form-assignments-list');
                const row = document.createElement('div');
                row.className = 'assignment-row grid grid-cols-3 gap-2';
                row.innerHTML = `
                    <input type="text" data-type="region" placeholder="المنطقة" class="p-2 w-full border bg-slate-700 border-slate-600 rounded-md" value="${assignment.region || ''}">
                    <input type="text" data-type="location" placeholder="الموقع" class="p-2 w-full border bg-slate-700 border-slate-600 rounded-md" value="${assignment.location || ''}">
                    <input type="text" data-type="project" placeholder="المشروع" class="p-2 w-full border bg-slate-700 border-slate-600 rounded-md" value="${assignment.project || ''}">
                `;
                list.appendChild(row);
            };

            document.getElementById('submit-coverage-guard-form-btn').addEventListener('click', async () => {
                const formId = document.getElementById('coverage-guard-form-id').value;
                const name = document.getElementById('coverage-guard-form-name').value.trim();
                const mobile_number = document.getElementById('coverage-guard-form-mobile').value.trim();
                const password = document.getElementById('coverage-guard-form-password').value.trim();
                
                const payload = { name, mobile_number };
                if (password) {
                    payload.password = password;
                }
            
                showLoading(true);
                let error;
            
                if (formId) { // Update
                    if (!name) {
                        showLoading(false);
                        return showAlert('الاسم حقل إلزامي.');
                    }
                    ({ error } = await _supabase.from('coverage_guards').update(payload).eq('id', formId));
                } else { // Insert
                    const id = document.getElementById('coverage-guard-form-national-id').value.trim();
                    if (!id || !name || !password) {
                        showLoading(false);
                        return showAlert('رقم الهوية، الاسم، وكلمة المرور حقول إلزامية.');
                    }
                    payload.id = id;
                    ({ error } = await _supabase.from('coverage_guards').insert(payload));
                }
                
                showLoading(false);
                if (error) {
                    if (error.message.includes('duplicate key')) showAlert('فشل الإضافة. رقم الهوية هذا مسجل بالفعل.');
                    else showAlert(`حدث خطأ: ${error.message}`);
                } else {
                    closeModal();
                    showAlert(formId ? 'تم تحديث البيانات بنجاح.' : 'تمت إضافة حارس التغطية بنجاح.');
                    loadHrDashboard('coverage_recruitment');
                }
            });

            document.getElementById('submit-staff-form-btn').addEventListener('click', async () => {
                const formId = document.getElementById('staff-form-id').value;
                const role = document.getElementById('staff-form-role').value;
                const assignments = Array.from(document.querySelectorAll('#staff-form-assignments-list .assignment-row')).map(row => ({
                    region: row.querySelector('[data-type="region"]').value.trim(),
                    location: row.querySelector('[data-type="location"]').value.trim(),
                    project: row.querySelector('[data-type="project"]').value.trim(),
                })).filter(a => a.region || a.location || a.project);
            
                const payload = {
                    name: document.getElementById('staff-form-name').value.trim(),
                    username: document.getElementById('staff-form-username').value.trim(),
                    job_title: document.getElementById('staff-form-title-input').value.trim() || null,
                    role: role,
                    assignments: assignments.length > 0 ? assignments : null,
                };
                const password = document.getElementById('staff-form-password').value;
                if(password) {
                    payload.password = password;
                }
            
                if (!payload.name || !payload.username) {
                    return showAlert('الاسم واسم المستخدم حقول إلزامية.');
                }
            
                showLoading(true);
                let error;
            
                if (formId) { // Update
                    ({error} = await _supabase.from('staff').update(payload).eq('id', formId));
                } else { // Insert
                    if (!password) {
                        showLoading(false);
                        return showAlert('كلمة المرور مطلوبة للموظف الجديد.');
                    }
                    ({error} = await _supabase.from('staff').insert(payload));
                }
            
                showLoading(false);
                if (error) {
                    showAlert(`فشلت العملية: ${error.message}`);
                } else {
                    showAlert(formId ? 'تم تحديث بيانات الموظف بنجاح.' : 'تمت إضافة الموظف بنجاح.');
                    closeModal();
                    const roleToTabMap = { 'hr': 'hr_staff', 'admin': 'supervisors', 'operations': 'operations'};
                    loadHrDashboard(roleToTabMap[role]);
                }
            });


            document.getElementById('submit-coverage-site-form-btn').addEventListener('click', async () => {
                const project = document.getElementById('coverage-site-project').value.trim();
                const location = document.getElementById('coverage-site-location').value.trim();
                const coverage_date = document.getElementById('coverage-site-date').value;
                const shift_day = document.getElementById('coverage-site-day').value;
                const shift_start = document.getElementById('coverage-site-start-time').value;
                const shift_end = document.getElementById('coverage-site-end-time').value;
                const payout_amount = parseFloat(document.getElementById('coverage-site-payout').value);
                const formId = document.getElementById('coverage-site-form-id').value;
                
                if (!project || !location || !coverage_date || !shift_start || !shift_end || !payout_amount) {
                    return showAlert('يرجى ملء جميع الحقول.');
                }
                
                const shift_details = `${shift_day} (${shift_start} - ${shift_end})`;

                const payload = { project, location, coverage_date, shift_day, shift_start, shift_end, shift_details, payout_amount, status: 'Available' };

                showLoading(true);
                let error, successMessage;

                if(formId) {
                    // Update Logic
                    ({error} = await _supabase.from('coverages').update(payload).eq('id', formId));
                    successMessage = "تم تحديث التغطية بنجاح!";
                } else {
                    // Insert Logic
                    ({error} = await _supabase.from('coverages').insert(payload));
                    successMessage = "تم إنشاء التغطية بنجاح!";
                }

                showLoading(false);
                if (error) {
                    showAlert(`حدث خطأ: ${error.message}`);
                } else {
                    closeModal();
                    showAlert(successMessage);
                    loadHrDashboard('coverage_sites');
                }
            });

            document.getElementById('submit-guard-form-btn').addEventListener('click', async () => {
                const formId = document.getElementById('guard-form-id').value;
                const weekly_schedule = {};
                document.querySelectorAll('#guard-form-schedule-container .grid').forEach(row => {
                    const day = row.querySelector('input[type="time"]').dataset.day;
                    const start = row.querySelector('input[data-type="start"]').value;
                    const end = row.querySelector('input[data-type="end"]').value;
                    if(start && end) {
                        weekly_schedule[day] = { start, end };
                    }
                });

                const payload = {
                    name: document.getElementById('guard-form-name').value.trim(),
                    mobile_number: document.getElementById('guard-form-mobile').value.trim(),
                    job_title: document.getElementById('guard-form-job-title').value.trim(),
                    location: document.getElementById('guard-form-location').value.trim(),
                    region: document.getElementById('guard-form-region').value.trim(),
                    project: document.getElementById('guard-form-project').value.trim(),
                    status: document.getElementById('guard-form-status').value,
                    basic_salary: parseFloat(document.getElementById('guard-form-basic-salary').value) || 0,
                    housing_allowance: parseFloat(document.getElementById('guard-form-housing-allowance').value) || 0,
                    transport_allowance: parseFloat(document.getElementById('guard-form-transport-allowance').value) || 0,
                    other_allowances: parseFloat(document.getElementById('guard-form-other-allowances').value) || 0,
                    weekly_schedule
                };
                
                const password = document.getElementById('guard-form-password').value;
                if(password) {
                    payload.password = password;
                }

                showLoading(true);
                let error;

                if(formId) { // Update existing guard
                    ({error} = await _supabase.from('guards').update(payload).eq('id', formId));
                } else { // Insert new guard
                    payload.id = document.getElementById('guard-form-national-id').value.trim();
                    if(!payload.id || !payload.password) {
                        showLoading(false);
                        return showAlert('رقم الهوية وكلمة المرور مطلوبان للحارس الجديد.');
                    }
                    ({error} = await _supabase.from('guards').insert(payload));
                }
                
                showLoading(false);
                if (error) {
                    showAlert(`فشلت العملية: ${error.message}`);
                } else {
                    showAlert(formId ? 'تم تحديث بيانات الحارس بنجاح.' : 'تمت إضافة الحارس بنجاح.');
                    closeModal();
                    loadHrDashboard('guards');
                }
            });
            
            showLoading(true);
            setupEventListeners();
            checkSession();
            showLoading(false);
        };
        runApp();
    });
    </script>
</body>
</html>
